# AWS SAP 备考：计算与无服务器架构（核心模块详解）
## 模块核心逻辑先理清
本模块的核心目标是 **“让计算资源弹性适配业务需求，同时减少运维负担”**，关键词：`解耦`（避免服务间强依赖）、`高并发`（应对流量峰值）、`冷启动`（降低响应延迟）。所有核心服务都是围绕这三个目标设计的，学习时先记住：**“服务的角色决定考点，考点源于底层原理”**。


## 一、ASG（Auto Scaling Group）—— 弹性伸缩“自动调度员”
### 1. 通俗理解
类比：餐厅根据客流量自动调度服务员——忙时（客流峰值）加派人手，闲时（低峰）减少人数，确保始终有足够服务员（实例），且不浪费人力（资源）。  
核心作用：**维持指定数量的“健康实例”，自动扩缩容应对流量变化，提高可用性**（避免单实例故障导致服务中断）。

### 2. 在此场景中的角色
解决“高并发”和“冷启动”的基础：高并发时快速扩容实例承接流量，冷启动问题通过“预热实例”优化。

### 3. 核心考点（结合底层原理+真题导向）
#### （1）Lifecycle Hooks（生命周期钩子）
- **底层原理**：实例从“启动”到“可用”、从“运行”到“终止”的过程中，有多个“生命周期阶段”（如 `launching`、`terminating`）。钩子允许在这些阶段“暂停实例流程”，执行自定义脚本（如安装软件、配置环境、备份数据）。
- **考点细节**：
  - 钩子的两种核心场景：
    - 启动时：实例启动后，先暂停在 `Pending:Wait` 状态，执行脚本（如安装监控代理），完成后通过 API 发送 `Proceed` 信号，实例才进入 `InService` 状态。
    - 终止时：实例终止前，暂停在 `Terminating:Wait` 状态，执行备份数据脚本，再继续终止。
  - 关键考点：钩子的“超时时间”（默认3600秒，超时未收到信号会按配置执行“继续”或“终止”）、“通知目标”（可将钩子事件发送到SNS/SQS/Lambda）。
- **真题级示例**：“某公司需要在ASG实例启动后自动安装特定版本的Java，应使用什么功能？” → 答案：Lifecycle Hooks + Lambda（执行安装脚本）。

#### （2）Warm Pools（预热池）
- **底层原理**：普通ASG扩容时，新实例需要“启动操作系统→安装软件→配置环境”（冷启动过程，可能耗时数十秒），导致流量峰值时响应延迟。Warm Pools提前启动实例并置于“待机状态”（Stopped或Running），需要时直接激活，跳过冷启动流程。
- **考点细节**：
  - 两种待机模式：
    - `Stopped` 模式（推荐）：实例处于停止状态，仅占用EBS存储资源，成本低；激活时快速启动（比全新启动快80%）。
    - `Running` 模式：实例持续运行，激活无延迟，但成本高。
  - 核心优势：减少扩容延迟，应对“突发流量”（如电商秒杀）。
  - 易混淆点：Warm Pools的实例不算在ASG的“期望实例数”中，仅作为备用资源。
- **真题级示例**：“某电商平台秒杀活动时，ASG扩容的实例启动耗时过长，导致用户访问超时，如何优化？” → 答案：配置Warm Pools（Stopped模式），提前预热实例。

### 4. 易混淆点
| 概念                | 核心区别                     | 适用场景                     |
|---------------------|------------------------------|------------------------------|
| Lifecycle Hooks     | 实例生命周期中插入自定义操作 | 启动时安装软件、终止时备份数据 |
| Warm Pools          | 提前预热实例，减少启动延迟   | 突发流量、低延迟需求场景     |


## 二、Lambda——无服务器“万能胶水”
### 1. 通俗理解
类比：外卖骑手——有订单（事件触发）才干活，不用管骑手在哪待命（服务器管理），干完活自动休息（资源释放）。  
核心作用：**事件驱动的无服务器函数，专注业务逻辑（代码），无需管理EC2、负载均衡等基础设施**，天生支持高并发（AWS自动扩容函数实例）。

### 2. 在此场景中的角色
- “胶水代码”：连接不同AWS服务（如S3上传文件→触发Lambda处理→结果存入DynamoDB）。
- 解决“高并发”：自动扩容函数实例（默认并发上限1000，可提额）。
- 优化“冷启动”：通过Provisioned Concurrency减少初始化延迟。

### 3. 核心考点（底层原理+实战配置）
#### （1）RDS Proxy（数据库连接池）
- **底层原理**：Lambda高并发时，每个函数实例会创建一个RDS数据库连接。如果并发量达1000，RDS的默认连接数（如MySQL默认151）会被耗尽，导致连接失败。RDS Proxy作为“中间代理”，复用数据库连接（多个Lambda实例共享一个Proxy连接），减少RDS连接数占用。
- **考点细节**：
  - 核心功能：
    - 连接池复用：降低RDS连接压力。
    - 故障转移支持：RDS主从切换时，Proxy自动路由到新主库，保持连接不中断。
    - 权限隔离：Lambda通过Proxy访问RDS，无需直接暴露RDS地址和凭证。
  - 配置要求：Lambda和RDS Proxy必须在同一VPC（或Proxy配置公网访问），且Lambda需拥有访问Proxy的IAM权限。
- **真题级示例**：“Lambda函数高并发访问RDS时，频繁出现‘Too many connections’错误，如何解决？” → 答案：部署RDS Proxy，配置Lambda通过Proxy访问RDS。

#### （2）Provisioned Concurrency（预置并发）
- **底层原理**：Lambda冷启动的原因是“首次运行/实例回收后重启时，需要初始化容器（下载代码、加载依赖、初始化运行环境）”，耗时100ms~数秒。Provisioned Concurrency提前初始化指定数量的Lambda容器，随时待命，触发时直接执行代码，无冷启动延迟。
- **考点细节**：
  - 与On-Demand Concurrency（默认模式）的区别：
    | 模式                | 冷启动情况 | 成本       | 适用场景               |
    |---------------------|------------|------------|------------------------|
    | On-Demand（默认）   | 可能有冷启动 | 按实际运行时间计费 | 低并发、非核心业务     |
    | Provisioned（预置） | 无冷启动   | 按预置数量计费 | 高并发、低延迟需求（如API接口） |
  - 配置方式：手动指定预置数量，或通过“自动扩展”根据流量动态调整。
- **真题级示例**：“某Lambda函数作为API Gateway的后端，要求响应时间<100ms，但首次调用经常超时，如何优化？” → 答案：为Lambda配置Provisioned Concurrency。

#### （3）结合EventBridge做自动化运维
- **底层原理**：EventBridge是“事件总线”，可收集AWS服务（如CloudWatch告警、S3上传、EC2状态变化）或自定义事件，根据规则将事件路由到Lambda、SNS等目标服务，实现“事件驱动的自动化”。
- **考点细节**：
  - EventBridge与CloudWatch Events的关系：EventBridge是CloudWatch Events的升级版，支持跨账户/跨区域事件、自定义事件总线。
  - 核心配置：事件模式（匹配特定事件，如“EC2实例变为stopped状态”）、目标（Lambda函数）、触发频率（如定时触发——类似 cron 表达式）。
  - 典型场景：
    - 定时运维：每天凌晨3点触发Lambda执行数据库备份。
    - 故障自动恢复：CloudWatch告警（EC2实例故障）→ EventBridge → Lambda → 重启实例。
- **真题级示例**：“如何实现‘当S3存储桶上传新的日志文件时，自动触发Lambda函数解析日志并存入Elasticsearch’？” → 答案：配置EventBridge规则，匹配“S3 ObjectCreated”事件，目标指定Lambda函数。

### 4. 关键误区
- 误区1：Lambda无冷启动 → 错！On-Demand模式下首次调用/实例回收后会有冷启动，Provisioned模式可解决。
- 误区2：Lambda并发无上限 → 错！默认并发上限1000，高并发场景需提前向AWS提额。


## 三、SQS + SNS——服务解耦“通信桥梁”
### 1. 通俗理解
- SNS（简单通知服务）：类比“广播电台”——发布者（如电商下单系统）发送一条消息，所有订阅者（如库存系统、支付系统、物流系统）同时接收。
- SQS（简单队列服务）：类比“快递柜”——发送者（如Lambda）放消息到队列，接收者（如另一个Lambda）按需取消息处理，无需双方同时在线。
- 组合作用：**解耦服务依赖**——避免“上游服务故障导致下游服务不可用”（如下单系统挂了，库存系统仍可从SQS读取未处理的订单消息）。

### 2. 在此场景中的角色
核心解决“解耦”，同时支持“高并发”（SQS可缓冲峰值流量，避免下游服务被压垮）。

### 3. 核心考点（对比+实战配置）
#### （1）SQS：Standard vs FIFO（队列类型对比）
| 特性                | Standard（标准队列）                | FIFO（先进先出队列）                |
|---------------------|-------------------------------------|-------------------------------------|
| 消息顺序            | 不保证（仅“至少一次交付”）          | 严格保证（按发送顺序处理）          |
| 去重                | 不保证（可能重复接收）              | 保证（5分钟内幂等，基于MessageDeduplicationId） |
| 吞吐量              | 高（默认1000 TPS，批量操作10000 TPS） | 低（默认300 TPS，批量操作3000 TPS） |
| 适用场景            | 高吞吐、不关心顺序（如日志收集）    | 需严格顺序（如订单支付、库存扣减）  |
| 核心考点            | 批量收发消息（减少API调用）         | MessageGroupId（同一组内顺序保证）、MessageDeduplicationId（去重） |

#### （2）DLQ（死信队列）
- **底层原理**：消息处理失败时（如接收者报错、处理超时），会被重新放入原队列重试。若重试次数超过“最大接收次数”（默认10次），消息会被转移到DLQ（死信队列），避免阻塞原队列。
- **考点细节**：
  - 配置方式：在SQS队列属性中指定“死信队列ARN”和“最大接收次数”。
  - 核心作用：保存失败消息，便于后续排查问题（如日志分析）、重试处理。
  - 注意：DLQ必须是与原队列同类型的队列（Standard→Standard，FIFO→FIFO）。
- **真题级示例**：“Lambda函数从SQS队列读取消息处理时，部分消息因业务逻辑错误反复重试，导致队列阻塞，如何处理？” → 答案：为SQS配置DLQ，设置最大接收次数为3，失败消息转移到DLQ后人工排查。

#### （3）SNS + SQS 组合使用
- 典型场景：电商下单后，SNS发布“下单事件”，多个SQS队列（库存队列、支付队列、物流队列）订阅该事件，各自的服务从队列中取消息处理。
- 考点：这种组合既实现了“一对多通信”（SNS），又保证了“消息可靠传递”（SQS的缓冲和重试），完全解耦上游发布者和下游消费者。


## 四、API Gateway——API流量“总入口”
### 1. 通俗理解
类比：商场大门——统一管理所有访客（客户端）的访问：
- 安检（鉴权）：验证访客身份，拒绝非法访问。
- 限流（控制人流）：避免太多人同时进入导致拥挤。
- 指路（路由）：将访客引导到对应的店铺（后端服务，如Lambda、EC2）。

### 2. 在此场景中的角色
- 流量入口：统一接收客户端API请求，转发到后端服务。
- 安全控制：鉴权、限流，保护后端服务。
- 无服务器集成：与Lambda无缝对接，构建无服务器API。

### 3. 核心考点（配置+安全）
#### （1）Private Endpoint（私有终端节点）
- **底层原理**：默认API Gateway是“公网可访问”的（通过互联网域名）。Private Endpoint通过VPC终端节点将API Gateway暴露在VPC内，仅允许VPC内的资源（如EC2、Lambda）访问，不经过公网，提高安全性。
- **考点细节**：
  - 配置要求：需要在VPC中创建“API Gateway Private Endpoint”，并关联安全组（控制VPC内哪些资源可访问）。
  - 访问方式：VPC内资源通过Private Endpoint的DNS名称访问API，无需公网出口。
  - 适用场景：内部系统API（如员工管理系统），不允许外部访问。

#### （2）Usage Plans（使用计划）
- **底层原理**：针对多租户场景（如API开放给多个客户使用），控制每个租户的API调用配额（如每天最多1000次）和节流（如每秒最多10次），避免单个租户滥用资源导致服务不可用。
- **考点细节**：
  - 核心组件：
    - API密钥：分配给租户，用于身份验证。
    - 配额（Quota）：长期限制（如每月5万次调用）。
    - 节流（Throttle）：瞬时限制（如每秒50次调用）。
  - 配置流程：创建Usage Plan → 绑定API阶段（如dev、prod）→ 生成API密钥 → 租户使用密钥访问API。
- **真题级示例**：“某公司将API开放给合作伙伴使用，需要限制每个合作伙伴每天最多调用1万次API，应如何配置？” → 答案：创建Usage Plans，设置配额为1万次/天，为每个合作伙伴分配独立API密钥。

#### （3）Lambda Authorizer（自定义鉴权）
- **底层原理**：API Gateway的鉴权方式有3种：IAM Authorizer（适用于AWS内部用户）、Cognito Authorizer（适用于用户认证）、Lambda Authorizer（自定义鉴权逻辑）。Lambda Authorizer通过调用Lambda函数验证客户端的身份（如验证JWT令牌、API密钥+密码），返回“允许”或“拒绝”访问的结果。
- **考点细节**：
  - 两种类型：
    - Token-based：客户端在请求头中携带令牌（如JWT），Lambda验证令牌有效性。
    - Request-based：Lambda根据请求参数（如查询字符串、请求体）鉴权。
  - 缓存机制：鉴权结果可缓存（默认300秒），减少Lambda调用次数，提高性能。
- **易混淆点对比**：
| 鉴权方式          | 适用场景                     | 灵活性       |
|-------------------|------------------------------|--------------|
| IAM Authorizer    | AWS内部用户（如EC2、Lambda） | 低（依赖IAM策略） |
| Cognito Authorizer | 终端用户认证（如App登录）    | 中（支持OAuth2.0） |
| Lambda Authorizer | 自定义鉴权逻辑（如JWT验证）  | 高（完全自定义代码） |


## 五、EKS / ECS——容器编排“管理平台”
### 1. 通俗理解
- ECS（弹性容器服务）：类比“AWS自建的集装箱码头”——管理Docker容器，无需关心底层Kubernetes，简单易用。
- EKS（弹性Kubernetes服务）：类比“兼容国际标准的集装箱码头”——托管Kubernetes集群，适合熟悉K8s的用户，支持复杂容器编排（如滚动更新、服务发现）。
- 核心作用：**简化容器的部署、扩展和管理**，支持无服务器容器（Fargate），减少运维负担。

### 2. 在此场景中的角色
解决“容器化应用”的弹性伸缩和运维问题，支持高并发（通过K8s/ECS的扩缩容机制），无服务器模式（Fargate）减少运维成本。

### 3. 核心考点（无服务器+托管特性）
#### （1）Fargate（无服务器容器）
- **底层原理**：传统ECS/EKS需要手动管理EC2节点（虚拟机），Fargate允许直接运行容器，AWS自动分配计算资源（CPU、内存），无需管理EC2节点（不用关心节点的扩容、补丁、故障修复）。
- **考点细节**：
  - 适用场景：中小型容器应用、运维资源有限的团队（无需维护EC2节点）。
  - 与EC2模式的区别：
    | 模式       | 运维成本 | 资源控制 | 适用场景               |
    |------------|----------|----------|------------------------|
    | Fargate    | 低（AWS管理节点） | 弱（按容器规格分配） | 中小型应用、快速部署   |
    | EC2模式    | 高（自行管理节点） | 强（可自定义EC2配置） | 大型应用、高性能需求   |
  - 考点：EKS和ECS都支持Fargate，Fargate容器只能运行在私有子网（无公网IP，需通过ALB暴露服务）。

#### （2）EKS托管节点组
- **底层原理**：EKS的节点组（EC2节点集合）分为“自管理节点组”和“托管节点组”。托管节点组由AWS管理节点的生命周期（包括节点的创建、更新、修复、替换），减少运维工作。
- **考点细节**：
  - 核心优势：自动更新K8s节点版本（与EKS集群版本兼容）、自动替换故障节点、支持Spot实例（节省成本）。
  - 配置要求：节点组使用的EC2实例需加入EKS集群的IAM角色（AmazonEKSWorkerNodePolicy）。
- **真题级示例**：“某公司使用EKS部署容器应用，希望减少节点的运维工作（如版本更新、故障修复），应选择哪种节点组？” → 答案：EKS托管节点组。


## 模块总结（备考核心口诀）
1. 解耦靠“SQS+SNS”：队列缓冲，通知扩散，服务不依赖。
2. 弹性靠“ASG+EKS/ECS”：实例伸缩，容器编排，应对高并发。
3. 无服务器核心“Lambda+API Gateway”：函数驱动，API入口，运维零负担。
4. 冷启动优化“Warm Pools+Provisioned Concurrency”：预热实例，预置并发，延迟降下来。
5. 安全控制“Private Endpoint+Lambda Authorizer+Usage Plans”：私有访问，自定义鉴权，限流保稳定。