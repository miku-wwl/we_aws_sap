# WAF & Shield Advanced：边缘防护双层盾（SAP考试深度拆解）
WAF（Web应用防火墙）和Shield Advanced是AWS边缘安全的核心组合，SAP考试中常以“架构设计题”“选型题”出现（占安全模块15%-20%），核心考查“分层防护逻辑”“服务互补关系”“场景化选型”。下面结合考点细节、真题案例、易混淆点对比，帮你彻底吃透：


## 一、核心定位：OSI分层防护+互补关系（必考）
两者的核心差异在于**防护层级和目标**，但必须结合使用才能实现“从网络层到应用层”的全链路边缘防护，类比“小区安保”：
- **Shield Advanced**：小区大门保安（OSI 3-4层），拦截大规模“暴力冲击”（如DDoS洪水攻击），不让攻击流量进入小区；
- **WAF**：单元楼门禁+安检（OSI 7层），对进入小区的人员（HTTP/HTTPS请求）做精细化检查，拦截“携带危险物品”的恶意请求（如SQL注入、XSS）。

### 关键补充（考试陷阱）：
1. **部署位置限制**：
   - 两者仅能部署在「AWS边缘节点/7层负载均衡」：CloudFront（CDN）、Route 53（DNS）、ALB（应用负载均衡）、API Gateway、AppSync；
   - ❌ 误区：WAF可以部署在NLB（网络负载均衡）？→ 错！NLB是4层负载均衡，不支持7层HTTP/HTTPS协议解析，WAF无法部署。
2. **防护边界**：仅针对“公网入站流量”，内网流量（如VPC内EC2互访）不经过两者防护，需用Security Group/NACLs。


## 二、底层原理：流量路径+防护逻辑（理解即得分）
### 1. 统一流量路径（边缘拦截核心价值）
公网用户访问后端应用的完整路径（结合防护层）：
```
用户 → 公网 → Route 53（DNS解析）→ CloudFront（CDN加速）→ Shield Advanced（3-4层DDoS拦截）→ WAF（7层应用攻击拦截）→ ALB（负载分发）→ 后端EC2/ECS/EKS
```
✅ 核心优势：攻击流量在**边缘节点（CloudFront/Route 53）** 被拦截，无需进入AWS区域内网，不占用后端服务器资源（比如DDoS流量在Shield层被过滤，不会触发EC2 Auto Scaling无意义扩容）。

### 2. 各自防护逻辑
| 服务                | 防护逻辑                          | 核心检测机制                          |
|---------------------|-----------------------------------|---------------------------------------|
| WAF（7层）          | 解析HTTP/HTTPS请求（头、参数、Cookie、路径），匹配规则拦截 | 规则集匹配（SQLi/XSS特征、IP黑名单、速率限制等） |
| Shield Advanced（3-4层） | 分析网络流量特征（流量峰值、连接数、协议异常），识别DDoS攻击 | 流量基线对比（正常流量vs异常流量）、攻击特征库匹配（SYN洪水、UDP洪水等） |


## 三、核心考点详解（SAP考试高频）
### （一）WAF：7层应用防护（考点密集）
#### 1. 防护对象与协议（必考识别题）
- 支持的协议：仅**HTTP/HTTPS/HTTP/2/QUIC**（Web应用专属）；
- 支持的防护目标（考试常考“不支持的目标”）：
  ✅ 支持：CloudFront、ALB、API Gateway、AppSync；
  ❌ 不支持：NLB（4层）、EC2实例（需通过ALB转发）、非Web服务（FTP、SSH等）。

#### 2. 核心攻击类型（题干关键词→对应防护规则）
| 攻击类型                | 攻击特征（题干常考描述）                          | WAF防护规则                          |
|-------------------------|---------------------------------------------------|---------------------------------------|
| SQL注入（SQLi）         | 请求参数含 `' OR 1=1 --`、`UNION SELECT` 等SQL语句 | AWS托管规则（`AWSManagedRulesSQLiRuleSet`）、自定义字符串匹配规则 |
| 跨站脚本（XSS）         | 请求含 `<script>alert('xss')</script>` 等恶意脚本 | AWS托管规则（`AWSManagedRulesCommonRuleSet`）、输入验证规则 |
| 路径遍历                | 请求路径含 `../`（如 `/../../etc/passwd`）        | 路径匹配规则，拦截含敏感路径字符的请求 |
| 速率限制（暴力破解/爬虫） | 单个IP短时间内发起大量请求（如登录接口每秒100次请求） | 速率限制规则（按IP/会话/地理位置限制请求频率） |
| 地理限制（合规需求）    | 禁止特定国家/地区访问（如仅允许中国IP访问）        | 地理匹配规则（基于MaxMind IP库）      |

#### 3. 规则类型（选型题核心）
| 规则类型                | 特点（考试考点）                          | 适用场景                          |
|-------------------------|-------------------------------------------|-----------------------------------|
| AWS托管规则（AWS Managed Rules） | 现成规则集，无需自定义，定期更新（AWS维护） | 快速部署、防常见攻击（如SQLi、XSS） |
| 自定义规则（Custom Rules）       | 按业务需求编写（支持IP、字符串、速率、地理等条件） | 个性化防护（如仅允许公司IP段访问后台） |
| 规则组（Rule Groups）             | 多个规则打包（可复用、可共享）              | 复杂业务场景（如电商前台+后台不同规则组） |

##### 真题示例（规则选型）：
**题目**：某公司的Web后台仅允许内部办公IP段（192.168.0.0/24）访问，同时需防护SQL注入攻击，应如何配置WAF？  
**答案**：启用AWS托管规则集（`AWSManagedRulesSQLiRuleSet`）+ 自定义IP匹配规则（允许192.168.0.0/24，拦截其他IP）。

#### 4. 动作类型（考试判断题）
WAF匹配规则后支持4种动作，需记住核心差异：
- `Allow`：允许请求通过；
- `Block`：直接拦截请求（返回403 Forbidden）；
- `Count`：不拦截，仅记录日志（用于测试规则或监控攻击）；
- `Captcha`：弹出验证码（拦截爬虫/自动化攻击，需用户手动验证）。


### （二）Shield Advanced：DDoS防护进阶（高频考点）
#### 1. 基础版 vs 高级版（核心对比，SAP必考）
| 维度                | Shield Basic（免费）                          | Shield Advanced（付费，年费约$3000起）                          |
|---------------------|-----------------------------------------------|----------------------------------------------------------------|
| 适用用户            | 所有AWS用户（默认启用）                        | 企业级用户（需手动开通）                                        |
| 防护范围            | 网络层基础DDoS攻击（SYN洪水、UDP洪水、ICMP洪水） | ① 网络层大规模DDoS（容量型攻击，如100Gbps+流量攻击）；② 应用层DDoS（如HTTP洪水、Slowloris）；③ 路由层攻击 |
| 核心权益            | 无附加权益                                    | ① 免除DDoS攻击期间的弹性扩容费用（EC2 Auto Scaling、ALB扩容等）；② 24/7 AWS DDoS响应团队（DRT）支持；③ 接入Route 53 DNS Firewall增强防护 |
| 依赖服务            | 无需绑定其他服务                              | 必须与WAF、CloudFront、Route 53或ALB结合使用（不能单独部署）    |

##### 考试陷阱：
- ❌ 误区：“Shield Advanced可以单独使用防护DDoS攻击”→ 错！必须结合WAF/CloudFront等服务；
- ✅ 必记：Shield Advanced的“扩容费用免除”仅针对「DDoS攻击期间」的自动扩容，正常业务扩容不免除。

#### 2. 核心价值（场景题考点）
- 大规模攻击防护：比如“双11期间面临100Gbps流量的DDoS攻击”，Shield Basic无法抵御，需Shield Advanced；
- 专业支持：攻击发生时，AWS DRT团队可协助配置防护策略、分析攻击源、优化规则；
- 合规支持：金融、政府客户的合规要求（如PCI DSS）需“DDoS防护能力认证”，Shield Advanced可满足。


## 四、应用场景：典型架构+真题案例（SAP考试重点）
### 1. 典型防护架构（必考）
**电商平台黑五/双11防护架构**：
```
用户 → Route 53（DNS解析+Shield Advanced）→ CloudFront（CDN加速+边缘缓存）→ WAF（防SQLi/XSS/速率限制）→ Shield Advanced（防DDoS）→ ALB → 后端ECS集群（Auto Scaling）
```
**架构设计逻辑**：
- CloudFront：边缘节点缓存静态资源，减少回源流量，同时作为防护第一层；
- Route 53 + Shield Advanced：拦截DNS层面攻击，确保解析可用性；
- WAF：过滤应用层恶意请求；
- Shield Advanced：抵御大规模DDoS，避免后端集群被打垮，同时免扩容费。

### 2. SAP真题示例（架构选型题）
**题目**：某金融科技公司的Web应用面临以下风险：① SQL注入、XSS攻击；② 大规模DDoS攻击（预计峰值流量50Gbps）；③ 攻击期间需弹性扩容应对流量，要求免除扩容费用；④ 需24/7专业安全团队支持。应选择哪些AWS服务组合？  
**答案**：WAF + Shield Advanced + CloudFront + Route 53  
**解析**：
- WAF防护应用层攻击（①）；
- Shield Advanced防护大规模DDoS（②）+ 免扩容费（③）+ 专业支持（④）；
- CloudFront+Route 53实现边缘防护，减少后端压力。


## 五、易混淆点：WAF vs Security Group vs NACLs（SAP高频对比）
很多考生混淆这三者的防护边界，用表格明确核心差异：
| 维度                | WAF（Web应用防火墙）                          | Security Group（安全组）                          | Network ACL（网络ACL）                          |
|---------------------|-----------------------------------------------|---------------------------------------------------|------------------------------------------------|
| OSI层级             | 7层（HTTP/HTTPS协议）                          | 3-4层（IP、端口）+ 部分7层（如ALB安全组支持HTTP路径） | 3-4层（IP、端口）                              |
| 防护对象            | Web应用（仅HTTP/HTTPS请求）                    | EC2、RDS、ALB等AWS资源（内网+公网流量）            | 子网（仅子网边界流量）                          |
| 状态性              | 无状态（每次请求独立判断）                      | 有状态（允许出站流量自动回流，无需额外规则）        | 无状态（入站、出站规则需分别配置）              |
| 核心功能            | 应用层攻击防护（SQLi、XSS、速率限制）          | 资源级访问控制（允许特定IP/端口访问）              | 子网级访问控制（拦截特定IP/端口，如黑名单）      |
| 适用场景            | 公网Web应用防护                                | 内网资源访问控制（如EC2仅允许ALB访问80端口）        | 子网边界防护（如禁止特定IP段访问子网）          |

##### 考试选型题：
**题目**：某公司需要限制仅允许特定IP段访问EC2上的SSH服务（22端口），应选择哪种服务？  
**答案**：Security Group（而非WAF，因为SSH是22端口，属于4层协议，WAF不支持）。


## 六、成本分析（SAP成本优化题考点）
### 1. WAF成本（按使用量收费）
- 规则集费用：每个规则组约$1-$5/月（AWS托管规则集+自定义规则组）；
- 请求数费用：每100万次HTTP/HTTPS请求约$1-$2（不同区域价格不同）；
- 成本优化：复用规则组、关闭未使用的规则、通过CloudFront缓存减少回源请求数。

### 2. Shield Advanced成本
- 基础年费：约$3000/年（全球范围）；
- 附加费用：超大流量攻击（如超过100Gbps）可能产生额外费用（需提前与AWS协商）；
- 成本逻辑：适合高价值业务（如电商、金融），避免攻击导致的业务中断损失（远高于年费）。


## 七、SAP考试核心考点总结（必记）
1. **选型逻辑**：
   - 应用层攻击（SQLi、XSS、速率限制）→ WAF；
   - 大规模DDoS（容量型、应用层）+ 免扩容费+专业支持 → Shield Advanced；
   - 4层协议防护（如SSH、FTP）→ Security Group/NACLs（非WAF）。
2. **部署限制**：
   - WAF仅支持CloudFront、ALB、API Gateway等7层目标，不支持NLB、EC2直接部署；
   - Shield Advanced不能单独使用，必须结合WAF/CloudFront/Route 53/ALB。
3. **易混淆点**：
   - WAF是7层应用防护，Security Group是3-4层资源访问控制；
   - Shield Basic免费，仅防基础DDoS；Shield Advanced付费，防大规模攻击+附加权益。
4. **架构题口诀**：
   - 公网Web应用防护：CloudFront（边缘）+ WAF（7层）+ Shield Advanced（DDoS）+ ALB（负载）。


## 八、零基础学习建议
1. **实操验证**：
   - 在AWS控制台创建WAF Web ACL，关联ALB，启用AWS托管规则集，测试用SQL注入语句访问ALB，观察WAF拦截效果；
   - 查看Shield Advanced的开通流程和权益说明，理解“依赖服务”的配置要求。
2. **画图记忆**：
   - 画流量路径图（用户→Route 53→CloudFront→WAF→Shield→ALB→后端），标注每个组件的防护作用；
   - 画WAF规则匹配流程图（请求→解析→规则匹配→允许/拦截）。
3. **刷题巩固**：
   - 针对“WAF防护对象”“Shield Advanced权益”“三者对比”做3-5道真题，强化陷阱记忆。