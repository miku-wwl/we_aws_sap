# KMS核心考点延伸：密钥轮换、跨账户访问、集成场景（SAP必考）

## 一、密钥轮换（CMK轮换 vs DEK轮换）：原理+考试陷阱
之前提到过CMK轮换，但未深入细节——SAP考试常考“轮换方式”“对历史数据的影响”，以及和DEK轮换的区别，这里补充完整：

### （1）CMK轮换的两种类型（考试必考区别）
CMK的轮换本质是“替换密钥材料”（CMK的ARN不变，仅底层密钥材料更新），不同CMK类型的轮换逻辑不同：
| CMK类型                | 轮换方式                          | 触发机制                          | 对历史数据的影响                          |
|-------------------------|-----------------------------------|-----------------------------------|-------------------------------------------|
| AWS托管CMK（aws/xxx）   | 自动轮换（AWS主导）               | 固定1年1次，用户无法修改/触发      | 无影响！旧密钥材料保留，可解密历史数据；新数据用新密钥材料加密 |
| 用户托管CMK（自定义）   | 手动轮换/自动轮换（用户配置）     | 手动触发（立即轮换）或设置轮换周期（1-365天） | 同AWS托管CMK，ARN不变，历史数据可解密     |
| BYOK（客户自有密钥）    | 密钥材料替换（用户主导）          | 手动导入新的密钥材料（替换旧材料） | 旧密钥材料可选择保留（用于解密历史数据）或删除（需谨慎） |

#### 核心考点：CMK轮换的“不变与变”
- ✅ 不变：CMK的ARN、密钥ID不变（应用无需修改配置，因为还是调用同一个CMK）；
- ✅ 变：底层密钥材料（加密的核心）更新；
- ❌ 误区：CMK轮换后，历史加密数据无法解密？→ 错！旧密钥材料会保留（AWS托管CMK永久保留，用户托管CMK可手动删除），确保历史数据能解密。

### （2）CMK轮换 vs DEK轮换（考试高频对比题）
之前讲过DEK是“数据密钥”，两者轮换的目的、场景完全不同，必须区分：
| 维度                | CMK轮换                          | DEK轮换                          |
|---------------------|----------------------------------|----------------------------------|
| 轮换对象            | CMK的密钥材料（根钥匙的“芯”）    | DEK（临时密码锁）                |
| 核心目的            | 降低CMK长期使用导致的泄露风险    | 降低单个DEK泄露影响多个数据的风险 |
| 触发频率            | 低（AWS托管1年1次，用户托管可更长） | 高（一个数据一个DEK，或定期更换） |
| 操作主体            | AWS（托管CMK）/用户（自定义/BYOK） | 用户/应用程序（调用`GenerateDataKey`生成新DEK） |
| 对应用的影响        | 无影响（ARN不变，无需改代码）    | 需重新加密新数据（旧数据仍用旧DEK） |

#### 考试真题示例
题目：某公司使用用户托管CMK加密S3数据，要求“每6个月更换一次密钥，且应用无需修改配置”，应选择哪种轮换方式？  
答案：用户托管CMK的自动轮换（设置6个月轮换周期）  
解析：CMK轮换ARN不变，应用无需改配置；DEK轮换需要应用重新生成DEK，需修改代码，不符合要求。

### （3）BYOK的特殊轮换逻辑（合规场景考点）
BYOK的轮换是“替换密钥材料”，流程如下（考试可能考步骤）：
1. 用户在本地生成新的密钥材料（如AES-256）；
2. 调用KMS的 `ImportKeyMaterial` API，将新密钥材料导入BYOK类型的CMK；
3. 导入成功后，KMS自动用新密钥材料加密新数据；
4. 旧密钥材料可选择“保留”（用于解密历史数据）或“删除”（需确保历史数据已迁移到新密钥）；
- 考点：BYOK轮换后，若删除旧密钥材料，历史数据将无法解密（风险极高），考试中若题干提到“保留历史数据解密能力”，需选择“保留旧密钥材料”。


## 二、跨账户/跨区域访问CMK：权限配置（SAP权限题核心）
企业多账户架构中，经常需要“账户A的应用访问账户B的CMK”，或“跨区域使用CMK”——这是SAP考试“权限配置题”的高频场景，核心是“两个权限条件必须同时满足”。

### （1）跨账户访问CMK的核心条件（必考）
要实现账户A（访问方）的IAM角色访问账户B（拥有方）的CMK，必须满足：
1. **账户B的CMK密钥策略允许账户A访问**（核心！密钥策略优先级高于IAM策略）；
2. **账户A的IAM角色拥有KMS操作权限**（如`kms:Encrypt`/`kms:Decrypt`）。

#### 示例：账户A（111111111111）访问账户B（222222222222）的CMK
- 步骤1：账户B在CMK的密钥策略中添加允许规则：
  ```json
  {
    "Sid": "AllowCrossAccountAccess",
    "Effect": "Allow",
    "Principal": { "AWS": "arn:aws:iam::111111111111:role/MyAppRole" }, // 账户A的IAM角色
    "Action": ["kms:Encrypt", "kms:Decrypt"], // 允许的操作
    "Resource": "*"
  }
  ```
- 步骤2：账户A给IAM角色`MyAppRole`附加IAM策略，允许KMS操作：
  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": ["kms:Encrypt", "kms:Decrypt"],
        "Resource": "arn:aws:kms:us-east-1:222222222222:key/xxx" // 账户B的CMK ARN
      }
    ]
  }
  ```
- 考点陷阱：只配置IAM策略，未配置密钥策略→ 访问失败（密钥策略是“第一道门”）；反之，只配置密钥策略，未配置IAM策略→ 也失败（IAM策略是“第二道门”）。

### （2）跨区域访问CMK的权限逻辑（结合多区域密钥）
- 单区域CMK：跨区域访问时，权限配置和跨账户一致（需密钥策略+IAM策略），但需注意“CMK的Region必须在IAM策略的Resource中明确指定”；
- 多区域CMK（MRK）：跨区域访问无需额外配置权限！因为MRK的密钥策略是“全局生效”的，只要密钥策略允许，任何区域的IAM角色都能访问（考试常考“MRK跨区域访问是否需要额外权限”→ 不需要）。

#### 考试真题示例
题目：账户A（us-east-1）的应用需要访问账户B（ap-southeast-1）的单区域CMK，以下哪项配置是必须的？（多选）  
A. 账户B的CMK密钥策略允许账户A的IAM角色访问  
B. 账户A的IAM角色附加允许访问该CMK的IAM策略  
C. 在账户A和账户B之间创建VPC Peering  
D. 给CMK启用多区域同步  
答案：AB  
解析：跨账户访问CMK只需密钥策略+IAM策略，无需网络连接（C错误）；单区域CMK无需启用多区域同步（D错误）。


## 三、KMS与其他AWS服务的集成：选型+考点
KMS是AWS加密生态的核心，几乎所有核心服务都支持与KMS集成——SAP考试常考“某服务如何使用KMS加密”“选型题”，这里整理高频集成场景：

### （1）存储类服务集成（S3、EBS、EFS）
| 服务                | 集成方式（考试考点）                          | 核心配置                          |
|---------------------|-----------------------------------------------|-----------------------------------|
| S3                  | SSE-KMS（服务端加密）                          | 桶配置或上传时指定CMK ARN（AWS托管`aws/s3`或用户托管CMK） |
| EBS                 | EBS卷加密                                      | 创建卷时选择“加密”，指定CMK（默认AWS托管`aws/ebs`） |
| EFS                 | 文件系统加密                                  | 创建EFS时启用“加密”，指定CMK（默认AWS托管`aws/efs`） |

#### 考点：S3 SSE-KMS vs SSE-S3（之前的疑问延伸）
- 题干出现“密钥可管控、审计、合规”→ 选SSE-KMS（KMS集成）；
- 题干出现“低成本、零配置”→ 选SSE-S3（非KMS，S3自研密钥）。

### （2）数据库类服务集成（RDS、DynamoDB、Redshift）
| 服务                | 集成方式（考试考点）                          | 核心配置                          |
|---------------------|-----------------------------------------------|-----------------------------------|
| RDS                 | 存储加密+备份加密                              | 启动实例时启用“存储加密”，指定CMK（默认AWS托管`aws/rds`） |
| DynamoDB            | 表加密+全局表加密                              | 创建表时启用“加密”，全局表需用多区域CMK（MRK） |
| Redshift            | 集群加密+快照加密                              | 启动集群时指定CMK，快照继承加密配置 |

#### 考试真题示例
题目：某公司使用DynamoDB全局表跨us-east-1和eu-west-1同步数据，要求数据加密且密钥可跨区域使用，应选择哪种CMK？  
答案：多区域CMK（MRK）  
解析：全局表需要同一CMK跨区域解密，单区域CMK无法满足，必须用MRK。

### （3）凭证/密钥类服务集成（Secrets Manager、ACM）
| 服务                | 集成方式（考试考点）                          | 核心考点                          |
|---------------------|-----------------------------------------------|-----------------------------------|
| Secrets Manager     | 凭证加密（默认用KMS）                          | 自定义CMK需给Secrets Manager授权`kms:Encrypt`/`kms:Decrypt` |
| ACM（证书管理器）   | 证书私钥加密（仅支持单区域CMK）                | 申请证书时指定单区域CMK（不支持MRK） |

#### 考点陷阱：ACM是否支持多区域CMK？→ 不支持！ACM证书的私钥加密只能用单区域CMK（考试常考“错误选项”）。

### （4）计算类服务集成（EC2、Lambda）
| 服务                | 集成方式（考试考点）                          | 核心配置                          |
|---------------------|-----------------------------------------------|-----------------------------------|
| EC2                 | 实例存储加密、AMI加密                          | AMI加密需指定CMK，启动实例时继承加密配置 |
| Lambda              | 环境变量加密                                  | 加密环境变量时，指定CMK（默认AWS托管`aws/lambda`） |

#### 考点：Lambda环境变量加密
- 题干：“如何确保Lambda的数据库密码不泄露？”→ 答案：用Secrets Manager存储密码，或用KMS加密Lambda环境变量。


## 四、KMS的审计与监控（合规考点）
企业合规（如GDPR、HIPAA）要求“加密操作可审计”——这是SAP考试合规模块的高频考点，核心围绕「CloudTrail日志」和「CloudWatch监控」：

### （1）审计：CloudTrail日志（必考）
KMS的所有操作（创建CMK、加密、解密、轮换、跨账户访问）都会被CloudTrail记录，日志包含：
- 操作人（IAM用户/角色）；
- 操作时间、Region；
- 操作类型（`kms:Encrypt`/`kms:Decrypt`/`CreateKey`等）；
- 目标CMK ARN、请求IP等。

#### 考点：“如何审计谁使用了KMS密钥？”→ 答案：查看CloudTrail日志中KMS相关的API调用记录。

### （2）监控：CloudWatch指标+告警（实操考点）
KMS提供CloudWatch指标，可监控密钥使用情况，设置告警：
- 核心指标：`EncryptRequests`（加密次数）、`DecryptRequests`（解密次数）、`KeyErrors`（密钥错误，如权限不足）；
- 常见告警场景：
  - 某CMK突然出现大量解密请求（可能是密钥泄露）；
  - 跨区域/跨账户访问CMK（需警惕未授权访问）。

#### 考试真题示例
题目：某公司需要监控KMS密钥的使用情况，当出现异常解密请求时立即告警，应配置什么服务？  
答案：CloudWatch指标（`DecryptRequests`）+ CloudWatch Alarms + SNS通知。


## 五、KMS高频易混淆点&考试陷阱（必记）
1. ❌ 误区：CMK轮换后，历史数据无法解密→ 错！旧密钥材料保留，可正常解密；
2. ❌ 误区：跨区域访问MRK需要额外配置权限→ 错！MRK密钥策略全局生效，无需额外配置；
3. ❌ 误区：ACM支持多区域CMK→ 错！ACM仅支持单区域CMK；
4. ❌ 误区：KMS可以加密大文件→ 错！CMK仅加密≤4KB数据，大文件需用信封加密（DEK+CMK）；
5. ✅ 必记：跨账户访问CMK必须同时配置“密钥策略+IAM策略”，缺一不可；
6. ✅ 必记：BYOK的密钥材料由用户生成，AWS无法接触原始密钥（合规场景核心考点）。


## 六、KMS核心考点总结（SAP考试必背清单）
1. **基础原理**：信封加密流程（`GenerateDataKey`→加密数据→`Decrypt`解密）；
2. **CMK选型**：根据“是否管控密钥、是否自有密钥材料、成本”选类型（AWS托管/用户托管/BYOK）；
3. **多区域密钥**：跨区域DR/全局表→选MRK，ARN含`multi-region`，密钥ID以`mrk-`开头；
4. **密钥轮换**：CMK轮换ARN不变，DEK轮换需重新生成；
5. **权限配置**：跨账户访问=密钥策略+IAM策略，MRK跨区域无需额外权限；
6. **集成场景**：S3 SSE-KMS、DynamoDB全局表+MRK、RDS存储加密；
7. **审计监控**：CloudTrail审计、CloudWatch监控告警。


## 七、零基础学习建议
1. **实操验证**：在AWS控制台创建用户托管CMK，配置密钥策略允许某IAM角色访问，然后用该角色调用KMS加密/解密，查看CloudTrail日志，感受完整流程；
2. **场景串讲**：用一个完整场景串联所有考点（比如“跨国电商用DynamoDB全局表，用MRK加密，跨账户授权给物流系统访问，通过CloudTrail审计，CloudWatch监控异常访问”）；
3. **刷题巩固**：针对每个考点找2-3道SAP真题练习，重点练“选型题”“权限配置题”“流程题”。