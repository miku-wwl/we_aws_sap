# AWS Secrets Manager：凭证的"智能保险箱"

## 一、核心定位与优势

**Secrets Manager**是AWS专为**敏感凭证管理**设计的服务，核心优势在于**自动轮换凭证**，彻底解决硬编码凭证导致的安全隐患。

**核心能力：**
- 安全存储：数据库密码、API密钥、OAuth令牌等敏感信息 
- 自动轮换：按预定义周期（如30天）自动更新凭证，无需人工干预 
- 集中管控：通过IAM和资源策略实现细粒度访问控制 
- 审计追踪：完整记录凭证访问和变更历史 

**SAP考试核心对比：vs Parameter Store**

| 特性 | Secrets Manager | Parameter Store |
|------|----------------|-----------------|
| **核心用途** | 敏感凭证（密码、密钥） | 普通配置+可选加密敏感参数  |
| **自动轮换** | ✓ 支持（RDS/Redshift等） | ✗ 需手动用Lambda实现  |
| **加密方式** | 必用KMS（默认aws/secretsmanager） | 可选KMS（SecureString类型） |
| **价格** | 约$0.40/月/凭证+API调用费 | 基础参数免费，高级参数低价  |
| **适用场景** | 需定期轮换的数据库密码、API密钥 | 无需轮换的配置参数、低成本敏感参数  |

**考试高频题：**"某公司需管理RDS数据库密码，要求每30天自动轮换，应选哪个服务？" → **Secrets Manager** 

## 二、底层原理详解

### 1. 存储加密机制

**Secrets Manager采用信封加密架构：**

- 所有凭证**强制使用KMS加密**（无法禁用），默认使用AWS托管密钥`aws/secretsmanager`，也可自定义CMK 
- 工作流程：
  1. 生成**唯一数据密钥**（256位AES）
  2. 用数据密钥加密凭证值
  3. 数据密钥再用KMS CMK加密，存储在凭证元数据中
  4. 明文数据密钥**立即从内存删除**，确保安全性 

**解密流程：**
- 调用`GetSecretValue`时，Secrets Manager先解密加密的数据密钥
- 使用明文数据密钥解密凭证值，返回后立即清除内存中的密钥 

### 2. 自动轮换机制（核心考点）

**Secrets Manager轮换必须依赖Lambda函数**（预定义模板已包含，无需自定义） 

**RDS密码轮换标准流程：**

1. **Secrets Manager触发**轮换（按设定周期）
2. 调用**Lambda函数**执行以下步骤：
   - 生成**新数据库密码**
   - 先更新Secrets Manager中的凭证（创建新版本）
   - 连接RDS实例，使用**超级用户权限**更新数据库密码
   - 验证新密码可成功登录
   - 标记轮换完成 

**单用户vs双用户轮换策略：**

| 策略 | 工作原理 | 适用场景 |
|------|---------|---------|
| **单用户轮换** | 直接更新同一数据库用户密码 | 简单场景，无读副本的数据库  |
| **双用户轮换** | 创建克隆用户→更新原用户→切换→删除旧用户 | 高可用架构，含读副本的数据库  |

**关键权限：**Lambda函数必须具备：
- `secretsmanager:GetSecretValue`（获取当前凭证）
- `secretsmanager:PutSecretValue`（更新凭证）
- `rds:ModifyDBInstance`（修改数据库密码）
- KMS解密权限（使用自定义CMK时） 

## 三、核心考点与功能详解

### 1. 自动轮换RDS密码（必考）

**配置步骤：**
1. 在Secrets Manager创建包含数据库凭证的密钥
2. 启用**自动轮换**，设置周期（如30天）和时间窗口
3. 选择轮换策略（单用户或双用户）
4. 创建/关联Lambda轮换函数（Secrets Manager提供预定义模板）
5. 为Lambda函数配置执行角色，授予必要权限 

**考试陷阱：**忘记为Lambda函数授予KMS解密权限会导致轮换失败 

### 2. 跨账户访问（权限题）

**实现跨账户访问需满足两个条件（缺一不可）：**

1. **资源策略（Resource Policy）：**在目标账户的Secrets Manager资源上，添加允许源账户IAM角色访问的策略

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {"AWS": "arn:aws:iam::源账户ID:role/角色名"},
         "Action": "secretsmanager:GetSecretValue",
         "Resource": "*"
       }
     ]
   }
   ```

2. **KMS权限：**如果凭证使用自定义CMK加密（非默认`aws/secretsmanager`），需在CMK的密钥策略中添加源账户角色的解密权限

   ```json
   {
     "Effect": "Allow",
     "Principal": {"AWS": "arn:aws:iam::源账户ID:role/角色名"},
     "Action": ["kms:Decrypt", "kms:DescribeKey"],
     "Resource": "*"
   }
   ```

**考试陷阱：**只配置资源策略，未配置KMS权限会导致访问失败 

**特殊情况：**若凭证使用**AWS托管CMK**（`aws/secretsmanager`），则**无需额外KMS权限**，资源策略即可 

### 3. 与Parameter Store的详细对比（选型题）

| 特性 | Secrets Manager | Parameter Store |
|------|----------------|-----------------|
| **设计目的** | 专业凭证管理，强调**自动轮换** | 配置参数管理，兼顾简单加密需求 |
| **数据类型** | 仅限**敏感凭证**（密码、密钥） | 混合：配置参数+敏感参数 |
| **自动轮换** | ✓ **内置支持**（RDS/Redshift等） | ✗ 需手动实现（通过Lambda） |
| **版本管理** | 全生命周期版本控制，支持并行多版本 | 基本版本管理，无并行版本支持 |
| **存储限制** | 单个凭证最大**64KB** | 参数值最大**4KB**（SecureString） |
| **价格** | 约**$0.40/月/凭证** + $0.05/万次API调用 | 基础参数**免费**，高级参数约$0.10/月 |
| **最佳实践** | 数据库密码、API密钥、OAuth令牌 | 应用配置、URL、端口等非敏感参数 |

**考试选型题：**"某电商平台需要管理MySQL数据库密码，要求每90天自动轮换，且能记录访问日志，应选择哪个服务？" → **Secrets Manager** 

### 4. 价格与成本分析（成本优化题）

**Secrets Manager定价：**
- **基础存储费：**约**$0.40/月/凭证** 
- **API调用费：**$0.05/10,000次请求 
- **免费层：**新账户前3个月免费（最多10个凭证） 

**对比AWS托管CMK：**如果只是需要加密（如S3默认加密），优先选择**AWS托管CMK**（完全免费），但无法自动轮换；若需**凭证轮换**，Secrets Manager是唯一选择 

## 四、易混淆点与注意事项

### 1. 必须掌握的限制条件

- **存储限制：**单个凭证最大**64KB**（适合密码、密钥等小数据，不适合大文件） 
- **加密要求：**所有凭证**必须使用KMS加密**，无法禁用（默认使用`aws/secretsmanager`） 
- **轮换依赖：**自动轮换**必须使用Lambda函数**，即使使用预定义模板 
- **跨区域复制：**支持跨区域复制，但复制后需在目标区域支付相同存储费用 

### 2. 与KMS的关系（重要区别）

- Secrets Manager是**KMS的消费者**，所有凭证加密都依赖KMS服务 
- KMS负责**密钥生成、加密和解密**，Secrets Manager负责**凭证生命周期管理** 
- Secrets Manager支持**自定义KMS密钥**，可选择不同CMK加密不同凭证 

### 3. 凭证版本与轮换状态

- Secrets Manager支持**多版本共存**，每个版本有唯一标签（如`AWSCURRENT`、`AWSPENDING`） 
- 轮换期间，新版本标记为`AWSPENDING`，验证成功后晋升为`AWSCURRENT` 
- 删除凭证时，默认保留所有历史版本（可配置删除策略） 

## 五、SAP考试核心考点总结

### 1. 原理类

- **信封加密流程：**Secrets Manager生成数据密钥→加密凭证→数据密钥用KMS CMK加密→存储加密后的数据密钥 
- **自动轮换机制：**Secrets Manager触发→Lambda生成新凭证→更新Secrets Manager→更新目标服务→验证→完成 

### 2. 选型类

- **数据库密码自动轮换：**首选Secrets Manager（Parameter Store不支持） 
- **跨账户凭证共享：**需同时配置资源策略和KMS权限（如用自定义CMK） 
- **低成本配置参数：**选Parameter Store；敏感凭证+自动轮换：选Secrets Manager 

### 3. 误区类

- ❌ 错误：Secrets Manager可以存储任意大小数据（真相：最大64KB） 
- ❌ 错误：Parameter Store也能自动轮换凭证（真相：需手动用Lambda实现） 
- ❌ 错误：跨账户访问只需配置资源策略（真相：若用自定义CMK，还需KMS权限） 

### 4. 权限类

- **凭证访问权限：**必须同时满足IAM策略和资源策略（资源策略优先级更高） 
- **轮换函数权限：**需授予Secrets Manager、KMS和目标服务（如RDS）的相应权限 

## 六、零基础学习建议

### 1. 动手实操（必做）

1. **创建Secrets Manager凭证：**
   - 在AWS控制台创建一个数据库凭证（如MySQL）
   - 启用自动轮换（如7天），选择单用户策略
   - 观察Lambda函数自动创建及执行情况 

2. **跨账户访问演练：**
   - 创建两个测试账户（A和B）
   - 在账户A创建凭证，配置资源策略允许账户B访问
   - 若使用自定义CMK，配置KMS权限
   - 在账户B编写简单脚本访问账户A的凭证 

### 2. 关键流程图（必画）

- **自动轮换流程：**Secrets Manager → Lambda → 目标服务（如RDS）→ 验证 → Secrets Manager 
- **跨账户访问流程：**源账户请求 → 资源策略验证 → KMS解密验证 → 返回凭证 

### 3. 常见场景练习（必练）

- **场景1：**电商平台管理RDS密码，要求每30天自动轮换，确保业务不中断
  → 选择Secrets Manager，配置**双用户轮换**策略 

- **场景2：**微服务架构中管理API密钥，不同团队只能访问特定API
  → 使用Secrets Manager，结合IAM和资源策略实现细粒度控制 

- **场景3：**多区域部署的应用，需共享数据库凭证
  → 使用Secrets Manager跨区域复制功能 

## 总结

Secrets Manager作为AWS安全体系的核心组件，完美解决了凭证管理的"最后一公里"问题。掌握其核心原理（自动轮换、信封加密）、选型要点（vs Parameter Store）和权限控制（跨账户访问），将在SAP考试中占据优势。