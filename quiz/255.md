#### 📝 [255/529] PrivateLink 连接排错 (NACL/SG)

**1. 🕵️‍♂️ 题眼与约束分析**
* **架构：** Client VPC $→$ Interface Endpoint $→$ NLB $→$ EC2 (Log Service)。
* **故障：** Clients cannot submit logs (不通)。
* **排查点：** NACL 和 Security Group。

**2. ⚡ 秒杀思路**
* **PrivateLink 数据流向：**
    * Client $→$ Interface Endpoint ENI (在 Client VPC)。
    * Interface Endpoint $→$ NLB (在 Service VPC)。
    * NLB $→$ EC2 (在 Service VPC)。
* **关键检查点：**
    * **NLB 安全组 (E):** NLB 以前没有安全组，但最近更新支持了。如果启用了，必须允许来自 **Interface Endpoint 子网**（如果是跨 VPC，其实是 Endpoint Service 的连接）的流量？不，PrivateLink 的流量对于 NLB 来说，源 IP 是 **Client 的 IP** (如果在同一个 VPC) 或者是 **NLB 自己的 IP** (如果启用了 Client IP Preservation，那是另一回事)。
    * **PrivateLink 的特殊性：** 流量到达 NLB 时，源 IP 会被替换为 **NLB 节点的 IP** (除非启用 Client IP Preservation，但那是针对 TGW 的，PrivateLink 有点不同)。
    * 对于 PrivateLink 也就是 Endpoint Service，Service 端的 NLB 看到的源 IP 是 **Endpoint Service 在 Service VPC 中创建的 ENI 的 IP**？不对。
    * **纠正：** PrivateLink 流量到达 Service VPC 时，是通过 **Gateway Load Balancer Endpoint** 或者是直接通过 NLB。对于 Interface Endpoint，AWS 会在 Service VPC 侧将流量通过 NLB 转发给后端。
    * **重点：** 后端 EC2 看到的是 **NLB 的 IP**。
    * 所以，**后端 EC2 的安全组**必须允许来自 **NLB 子网**的流量。
    * $→$ **选中 C** (Check SG on EC2 allows ingress from NLB subnets)。
* **NACL (A):**
    * NACL 是无状态的，必须允许进和出。
    * **NLB 子网 NACL:** 必须允许来自 Endpoint（或者是 Service VPC 内部流量）的入站，以及去往 EC2 的出站。
    * **EC2 子网 NACL:** 必须允许来自 NLB 的入站，以及回包给 NLB 的出站。
    * 选项 A 说 "Check NACL on Log Service subnet... allow comms with NLB subnet"。这是对的。
* **排除法：**
    * 选项 B: 提到 "Interface Endpoint Subnet"。Interface Endpoint 在 Client VPC（不同的账户）。Service VPC 的 NACL 无法配置允许 "Client VPC Subnet"（因为 IP 可能重叠，且是通过 PrivateLink 隧道过来的）。在 Service VPC 侧，流量看起来像是从 NLB 出来的（或者从 PrivateLink 的隐藏 ENI）。通常只要允许 VPC 内部通信即可。
    * 选项 D: EC2 SG 允许 Client IP？不行，PrivateLink 会做 SNAT（除非开了 Proxy Protocol，但 SG 依然只看 IP包头，包头是 NLB IP）。
    * 选项 E: NLB SG。虽然 NLB 现在支持 SG，但通常 EC2 SG 才是最后一道防线。且 C 和 A 更基础。
    * **结论：** 最常见的配置错误是 **EC2 安全组没放行 NLB** (C) 和 **NACL 阻断了子网间通信** (A)。
    * **锁定 A, C。**

**3. ✅ 正确选项解析 (选项 A, C)**
* **A (NACL):** 确保 NLB 子网和 EC2 子网之间双向畅通。
* **C (Security Group):** 确保后端实例允许来自负载均衡器的流量。

**5. 📚 核心考点:** PrivateLink 后端网络路径的故障排查。