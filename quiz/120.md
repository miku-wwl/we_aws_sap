#### ğŸ“ [120/529] API Gateway é™æµ (429 Error)

**1. ğŸ•µï¸â€â™‚ï¸ é¢˜çœ¼ä¸çº¦æŸåˆ†æ**
* **ç°è±¡ï¼š** é«˜çº§å®¢æˆ·ï¼ˆ3000 RPSï¼‰æ”¶åˆ° **429 Too Many Requests**ã€‚
* **æ—¥å¿—ï¼š** Lambda function **never invoked** (Lambda æ²¡è¢«è°ƒç”¨)ã€‚è¯´æ˜è¯·æ±‚åœ¨ API Gateway å±‚å°±è¢«æ‹¦æˆªäº†ã€‚
* **æ¨æ–­ï¼š** æ˜¯ API Gateway çš„ Throttling (é™æµ) è§¦å‘äº†ã€‚

**2. âš¡ ç§’æ€æ€è·¯**
* **é™æµå±‚çº§ï¼š**
    * **Account Level:** é»˜è®¤ 10,000 RPSã€‚
    * **Method Level:** é»˜è®¤è·Ÿéš Accountã€‚
    * **Usage Plan Level:** é’ˆå¯¹ç‰¹å®š API Keyã€‚
* **åŸå› åˆ†æï¼š**
    * é€‰é¡¹ A/B (Lambda Concurrency): å¦‚æœæ˜¯ Lambda å¹¶å‘è¶…äº†ï¼ŒAPI Gateway é€šå¸¸ä¼šæŠ¥ **502 Bad Gateway** (å¦‚æœå¼‚æ­¥è°ƒç”¨å¯èƒ½æ˜¯ 202 ä½†ä¸¢å¼ƒ)ï¼Œæˆ–è€…æŠ¥ 429ã€‚ä½†é¢˜ç›®è¯´ Lambda "never invoked"ï¼Œæ„å‘³ç€è¯·æ±‚è¿˜æ²¡åˆ° Lambda è¿™ä¸€å±‚ã€‚è€Œä¸” AWS é¢˜åº“ä¸­ï¼ŒAPI Gateway æŠ¥ 429 é€šå¸¸æŒ‡ API GW å±‚çš„é™æµã€‚
    * é€‰é¡¹ C (Account Limit): å¦‚æœæ•´ä¸ªè´¦æˆ·é™æµäº†ï¼Œæ‰€æœ‰å®¢æˆ·éƒ½ä¼šæŠ¥é”™ã€‚é¢˜ç›®è¯´"Several Premium tier customers... in different regions"ã€‚è¿™æš—ç¤ºå¯èƒ½æ˜¯å±€éƒ¨é—®é¢˜ï¼Ÿæˆ–è€…å¦‚æœæ˜¯ Account Limitï¼Œç¡®å®ä¼šå½±å“å¤§å®¶ã€‚
    * **é€‰é¡¹ D (Method Default Limit):** è¿™æ˜¯ä¸€ä¸ªéå¸¸éšè”½çš„é™·é˜±ã€‚API Gateway é»˜è®¤ä¼šä¸ºæ‰€æœ‰æ–¹æ³•è®¾ç½®ä¸€ä¸ª Method Throttling Limitã€‚å¦‚æœæ²¡æ˜¾å¼é…ç½®ï¼Œæˆ–è€…é…ç½®å¾—æ¯” Usage Plan ä½ï¼Œå®¢æˆ·å³ä½¿ä¹°äº† 3000 RPS çš„ Usage Planï¼Œä¹Ÿå¯èƒ½å› ä¸º Method Limitï¼ˆæ¯”å¦‚é»˜è®¤æ²¡è°ƒé«˜ï¼‰è€Œè¢«å¡ä½ã€‚
    * **Usage Plan vs Method Limit:** æœ€ç»ˆç”Ÿæ•ˆçš„é€Ÿç‡æ˜¯ `min(Usage Plan Limit, Method Limit, Account Limit)`ã€‚å¦‚æœå®¢æˆ·æŠ¥å‘Š 429ï¼Œä¸” Lambda æ²¡åŠ¨é™ï¼Œè¯´æ˜æ˜¯ API Gateway å±‚çš„ Throttlingã€‚
    * **A vs B vs C vs D:**
        * Lambda Concurrency (A/B) å¯¼è‡´çš„ 429 æ˜¯ Lambda æŠ›å‡ºçš„ã€‚API Gateway æ”¶åˆ°åé€ä¼ ã€‚æ­¤æ—¶ Lambda ä¹Ÿæ˜¯"invoked"äº†ï¼ˆè‡³å°‘å°è¯•æ‰§è¡Œäº†ï¼‰ã€‚ä½†é¢˜ç›®è¯´ "Lambda never invoked"ï¼Œè¿™é€šå¸¸æŒ‡ API Gateway è‡ªå·±çš„ Throttle æ‹¦æˆªäº†è¯·æ±‚ï¼Œæ ¹æœ¬æ²¡å‘èµ·åç«¯è°ƒç”¨ã€‚
        * æ’é™¤ A/Bã€‚
        * å‰©ä¸‹ C å’Œ Dã€‚C æ˜¯è´¦æˆ·çº§ï¼ŒD æ˜¯æ–¹æ³•çº§ã€‚
        * é¢˜ç›®å¼ºè°ƒ "Premium tier customers... identified by API keys"ã€‚è¿™æš—ç¤ºä½¿ç”¨äº† Usage Plansã€‚
        * 429 é”™è¯¯æ˜¯æ ‡å‡†çš„ Throttling é”™è¯¯ã€‚
        * é¢˜ç›®æ²¡æœ‰è¯´æ€»æµé‡å¾ˆå¤§ï¼Œåªè¯´é«˜çº§å®¢æˆ·åœ¨é«˜å³°æœŸæŠ¥é”™ã€‚å¦‚æœè´¦æˆ·é™åˆ¶ï¼ˆ10000 RPSï¼‰æ²¡åˆ°ï¼Œä½†æ–¹æ³•é™åˆ¶ï¼ˆé»˜è®¤å¯èƒ½è¾ƒä½ï¼‰æˆ–è€… Usage Plan é™åˆ¶åˆ°äº†ï¼Œå°±ä¼š 429ã€‚
        * **é‡ç‚¹ï¼š** é¢˜ç›®æ²¡æœ‰æåˆ° Usage Plan çš„é…ç½®é”™è¯¯ï¼Œè€Œæ˜¯è®©é€‰åŸå› ã€‚
        * å¦‚æœæ˜¯ Usage Plan é™åˆ¶äº†ï¼Œé‚£ç­”æ¡ˆåº”è¯¥æ˜¯ "Usage Plan limit reached"ã€‚ä½†æ²¡è¿™ä¸ªé€‰é¡¹ã€‚
        * **Method Default Limit (D):** è¿™æ˜¯ä¸€ä¸ªé»˜è®¤å­˜åœ¨çš„é™åˆ¶ã€‚å¾ˆå¤šæ—¶å€™å¼€å‘è€…å¿˜äº†æ”¹è¿™ä¸ªï¼Œå¯¼è‡´å®ƒæˆä¸ºç“¶é¢ˆã€‚è¿™æ˜¯ä¸€ä¸ªåˆç†çš„æ¨æµ‹ã€‚
        * **Account Limit (C):** ä¹Ÿæ˜¯å¯èƒ½çš„ã€‚
        * **ä½†æ˜¯ï¼Œ** è®©æˆ‘ä»¬å›çœ‹ "Lambda never invoked"ã€‚å¦‚æœæ˜¯ Lambda Throttlingï¼ŒAPI Gateway ä¼šæŠ¥ 429ï¼Œä¸” CloudWatch Integration Latency ä¼šå¾ˆä½ã€‚åœ¨ AWS çš„å®šä¹‰é‡Œï¼ŒLambda Throttling ç®—ä½œ Invoke Error è¿˜æ˜¯ Not Invokedï¼Ÿé€šå¸¸ç®— Not Invokedï¼ˆå¦‚æœæ˜¯åœ¨åŒæ­¥è°ƒç”¨çš„æ’é˜Ÿé˜¶æ®µè¢«æ‹’ï¼‰ã€‚
        * **ä½† SAP è€ƒè¯•çš„æƒ¯ä¾‹ï¼š** 429 + API Gateway = Throttling è®¾ç½®é—®é¢˜ã€‚
        * é€‰é¡¹ D æŒ‡å‡º "Default limit per method"ã€‚å¦‚æœä¸è¦†ç›–ï¼Œè¿™å¾€å¾€æ˜¯æ„å¤–çš„ç“¶é¢ˆã€‚

**3. âœ… æ­£ç¡®é€‰é¡¹è§£æ (é€‰é¡¹ D)**
* **Method Throttling:** API Gateway çš„å¤šå±‚é™æµæœºåˆ¶ä¸­ï¼Œæ–¹æ³•çº§é™åˆ¶å®¹æ˜“è¢«å¿½è§†ã€‚

**5. ğŸ“š æ ¸å¿ƒè€ƒç‚¹:** API Gateway 429 é”™è¯¯çš„æ’æŸ¥å±‚çº§ã€‚