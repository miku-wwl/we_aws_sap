#### ğŸ“ [427/529] CloudFront è‡ªå®šä¹‰å¤´å¢å¼ºæºç«™å®‰å…¨ (Secret Header)

**1. ğŸ•µï¸â€â™‚ï¸ é¢˜çœ¼ä¸çº¦æŸåˆ†æ**
* **æ¶æ„ï¼š** CloudFront -> ALB -> EC2ã€‚
* **æ¼æ´ï¼š** ALB is Public (in public subnets)ã€‚
* **éœ€æ±‚ï¼š** **Enhance origin security** (é˜²æ­¢ç»•è¿‡ CloudFront ç›´æ¥è®¿é—® ALB)ã€‚

**2. âš¡ ç§’æ€æ€è·¯**
* **æ–¹æ³• 1ï¼šIP ç™½åå• (B/D)ã€‚**
    * ä½¿ç”¨ Managed Prefix List (å®‰å…¨ç»„) æˆ– WAF IP Setã€‚
    * é€‰é¡¹ B è¯´ "Create WAF rule with IP match... move ALB to private subnets"ã€‚
        * ALB å¿…é¡»åœ¨ Public Subnet æ‰èƒ½è¢« CloudFront è®¿é—®ï¼ˆé™¤é CloudFront ç”¨äº†ç§æœ‰è¿æ¥åŠŸèƒ½ï¼Œä½†è¿™å¾ˆæ–°ä¸”æœ‰é™åˆ¶ï¼Œé€šå¸¸ ALB æ˜¯ Public çš„ï¼‰ã€‚å¦‚æœæŠŠ ALB ç§»åˆ° Private Subnetï¼ŒCloudFront å°±è¿ä¸ä¸Šäº†ã€‚B é”™åœ¨ç§»åŠ¨ ALBã€‚
        * D è¯´ "Shield Advanced... SG Allow CloudFront IPs"ã€‚Shield Advanced æ˜¯é˜² DDoS çš„ï¼Œè™½ç„¶é€ WAFï¼Œä½† SG è§„åˆ™æ›´ç›´æ¥ã€‚ä½† CloudFront IP èŒƒå›´å¾ˆå¤§ã€‚
* **æ–¹æ³• 2ï¼šè‡ªå®šä¹‰å¤´ (Custom Header) (A/C)ã€‚**
    * CloudFront æ·»åŠ ä¸€ä¸ª **Secret Header** (e.g. `X-Secret-Token: random-string`)ã€‚
    * ALB (é€šè¿‡ WAF æˆ– Listener Rule) æ£€æŸ¥è¿™ä¸ªå¤´ã€‚å¦‚æœæ²¡æœ‰æˆ–ä¸å¯¹ï¼Œæ‹’ç»ã€‚
    * è¿™æ ·å³ä½¿æ”»å‡»è€…çŸ¥é“ ALB IPï¼Œæ²¡æœ‰ Token ä¹Ÿè¿›ä¸å»ã€‚
    * **Secrets Manager vs Parameter Store:**
        * **A:** Secrets Manager + Lambda Rotation + WAF Rule (String Match)ã€‚
            * WAF æ”¯æŒå­—ç¬¦ä¸²åŒ¹é…ã€‚Secrets Manager æ”¯æŒè‡ªåŠ¨è½®æ¢ã€‚CloudFront æ”¯æŒæ·»åŠ å¤´ã€‚
            * è¿™æ˜¯ä¸€ä¸ªéå¸¸å®‰å…¨çš„é—­ç¯ï¼šå®šæœŸè½®æ¢å¯†é’¥ï¼ŒWAF è‡ªåŠ¨æ›´æ–°è§„åˆ™ï¼ˆé€šè¿‡ Lambdaï¼‰ï¼ŒCloudFront è‡ªåŠ¨æ›´æ–°é…ç½®ï¼ˆé€šè¿‡ Lambdaï¼‰ã€‚
        * **C:** Parameter Store + ALB Listener Rule? ALB Listener Rule æ”¯æŒ header æ£€æŸ¥ã€‚ä½† C é€‰é¡¹è¯´ "Check value of custom header and block in ALB"ã€‚ALB Listener Rule ç¡®å®å¯ä»¥åšã€‚ä½† Parameter Store çš„è½®æ¢æœºåˆ¶ä¸å¦‚ Secrets Manager å®Œå–„ï¼ˆéœ€è¦è‡ªå®šä¹‰ï¼‰ã€‚
    * **æ¯”è¾ƒ A å’Œ C:** A æ–¹æ¡ˆå¼•å…¥äº† WAFï¼Œæ›´åŠ æ ‡å‡†åŒ–å’Œå®‰å…¨ï¼ˆWAF æ˜¯ä¸“é—¨åšè¯·æ±‚è¿‡æ»¤çš„ï¼‰ã€‚è€Œä¸” Secrets Manager æ˜¯å‡­è¯ç®¡ç†çš„æœ€ä½³å®è·µã€‚C åœ¨ ALB ä¸Šåš Block ä¹Ÿå¯ä»¥ï¼Œä½† A çš„ "String Match Rule" åœ¨ WAF å±‚é¢æ‹¦æˆªæ›´é«˜æ•ˆã€‚
    * æ›´å…³é”®çš„æ˜¯ï¼Œ**A é€‰é¡¹** æè¿°äº†ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–è½®æ¢æµç¨‹ã€‚
    * **å¦å¤–ï¼š** é€‰é¡¹ B çš„ IP é™åˆ¶ä¹Ÿæ˜¯ä¸€ç§æ–¹æ³•ï¼Œä½†å®ƒé”™è¯¯åœ°æŠŠ ALB ç§»åˆ°äº†ç§æœ‰å­ç½‘ã€‚
    * **æ‰€ä»¥ A æ˜¯æœ€ä½³çš„"å¢å¼ºå®‰å…¨æ€§"æ–¹æ¡ˆï¼ˆShared Secretï¼‰ã€‚**
    * **é”å®š Aã€‚**

**3. âœ… æ­£ç¡®é€‰é¡¹è§£æ (é€‰é¡¹ A)**
* **Custom Header (Shared Secret):** ç¡®ä¿è¯·æ±‚æ¥è‡ª CloudFrontã€‚
* **Secrets Manager + WAF:** è‡ªåŠ¨åŒ–å¯†é’¥è½®æ¢ä¸éªŒè¯ã€‚

**5. ğŸ“š æ ¸å¿ƒè€ƒç‚¹:** CloudFront Origin å®‰å…¨åŠ å›º (Shared Secret pattern)ã€‚

---
**æ­å–œä½ ï¼Œ427 é¢˜ï¼**