#### 📝 [416/529] 多租户 DynamoDB 成本分摊 (Custom Metrics)

**1. 🕵️‍♂️ 题眼与约束分析**
* **架构：** SaaS (Multi-tenant), Shared DynamoDB tables。
* **需求：** Allocate cost per tenant (按租户分摊成本)。
* **数据：** TenantID in request。
* **目标：** **Least operational effort**, **Granular view** (细粒度)。

**2. ⚡ 秒杀思路**
* **成本归因难点：** 共享表无法通过 AWS Tags 区分租户成本（Tags 只能打在表上）。必须在**应用层**统计每个租户的消耗。
* **解决方案：**
    * **记录消耗：** Lambda 在读写 DynamoDB 时，可以获取 `ConsumedCapacity` (RCU/WCU)。
    * **聚合与计算：**
        * 选项 A (Tags): 只能分摊表级成本，无法分摊租户级。
        * 选项 B (Log to CW + Lambda calc): 自己写 Lambda 算钱？复杂。
        * 选项 C (New Partition Key?): 改表结构？大动干戈。
        * **选项 D:** Log TenantID + Metrics to **CloudWatch Logs (EMF / Custom Metrics)**?
            * 其实，最精确的方法是记录每个请求的消耗。
            * **D 选项建议:** Lambda log metrics (TenantID, size, duration) to CloudWatch Logs。Use **CloudWatch Logs Insights** query。Use Pricing Calculator。
            * 这虽然能算出来，但是否是 "Least operational effort"?
    * **让我们重看 B:** "Log TenantID and consumed RCUs/WCUs to CloudWatch Logs... Deploy another Lambda to calculate... EventBridge schedule"。这个方案实现了全自动的成本计算报告。
    * **对比 B 和 D:** D 需要手动去 Insights 查询再手动去计算器算？B 是自动化的。
    * **然而，** 还有一种方法：**Application Cost Profiler** (AWS 新服务)。但选项没提。
    * **再看 A:** "Associate a new tag named TenantID to each table"。如果每个租户一个表，那 A 是对的。但题目说 "Tables are shared by tenants"。所以 A 错。
    * **结论：** 必须在应用层捕获 RCU/WCU。
    * 选项 B 的逻辑是：记录 -> 聚合 -> 计算。这是唯一可行的路径。虽然写 Lambda 有工作量，但这是针对"共享资源"进行精细成本分摊的唯一办法。
    * **修正：** 其实 D 也是一种方法，但 D 记录的是 Size/Duration，DynamoDB 是按 CU 计费的，直接记录 CU (B) 更准。
    * **锁定 B。**

**3. ✅ 正确选项解析 (选项 B)**
* **Application-level Metering:** 在代码中捕获每个租户的实际资源消耗（RCU/WCU）。
* **Custom Calculation:** 基于消耗量计算分摊成本。

**5. 📚 核心考点:** 共享资源（多租户）的成本分摊策略。

---
**恭喜你，416 题！**