#### 📝 [222/529] ASG 实例替换后的路由更新 (Lifecycle Hook)

**1. 🕵️‍♂️ 题眼与约束分析**
* **场景：** ASG (3 实例) + Network Analysis Software。
* **问题：** ASG 替换实例时，**Network routes were not updated** (路由没更新，流量还在发给旧实例或没发给新实例)。
* **目标：** Solve this issue (自动化更新路由)。
* **选择：** 3 个步骤。

**2. ⚡ 秒杀思路**
* **自动化流程：**
    * 当 ASG 启动新实例时，处于 `Pending` 状态。
    * 此时需要执行逻辑（更新路由表，将流量指向新实例 ENI）。
    * 执行完毕，实例进入 `InService`。
    * 当 ASG 终止旧实例时，处于 `Terminating` 状态。
    * 执行逻辑（从路由表删除旧实例）。
* **技术实现：** **ASG Lifecycle Hooks**。
* **选项分析：**
    * **选项 D:** CloudWatch Alarm + SNS？Alarm 是监控指标的，不是监控 ASG 生命周期事件的。ASG 生命周期事件可以直接发 SNS/EventBridge。
    * **选项 E:** Lambda 响应 SNS，更新路由。这是核心逻辑。 -> **选中 E**。
    * **选项 F:** CloudFormation Condition？CFN 只是部署资源，不能处理运行时的动态扩缩容事件。
    * **选项 B/C:** 安装 Agent 发送指标？这跟路由更新没关系。
    * **选项 A:** 健康检查？这是触发替换的原因，不是解决路由更新的方法。
    * **重新审视选项：**
        * 题目问 "Which **combination** of steps"。
        * 显然 E (Lambda 更新路由) 是必须的。
        * 谁触发 Lambda？通常是 **ASG Lifecycle Hook -> SNS -> Lambda**。
        * 或者是 **EventBridge -> Lambda**。
        * 选项 D 说 "Create alarm for custom metric... publish to SNS"。这有点怪。
        * 让我们看看有没有更好的触发源。
        * **ASG Lifecycle Hook** 是标准答案，但选项里没直接提 "Create Lifecycle Hook"。
        * **选项 F** 说 "Write a condition in CloudFormation to update routes"。这是胡扯。
        * **选项 B/C** 是关于安装 Agent。
        * **难道题目是想说：** 1. 监控软件状态 (B/C) -> 2. 触发报警 (D) -> 3. 执行动作 (E)?
        * 题目说 "When analysis software stops working, ASG replaces an instance"。这说明**检测和替换**已经工作了（可能是基于 EC2 健康检查）。
        * 问题是 **"Network routes were not updated"**。
        * 所以我们需要一个机制在**实例启动/终止**时触发 Lambda。
        * **选项 D** 提到了 "Create alarm... publish to SNS"。这可能是指软件故障的报警？但这会导致 ASG 替换。
        * **其实，** 这道题的完整逻辑应该是：
            1.  **C (Install SSM Agent):** 既然是自定义软件，可能需要发送自定义指标来判断软件是否活着（不仅仅是 EC2 活着）。或者 SSM 可以运行脚本。
            2.  **D (Alarm + SNS):** 如果软件挂了，发 SNS。
            3.  **E (Lambda):** 收到 SNS，把旧实例拿掉（Detachment?），更新路由？
        * **但是，** 题目说 "ASG replaces an instance"。这意味着 ASG 已经知道实例挂了。
        * **我们需要的仅仅是：** 捕捉 ASG 的 **Launch/Terminate** 事件。
        * 选项里没有 EventBridge 或 Lifecycle Hook。
        * 让我们看 **CloudFormation**。CFN 可以部署 **SNS Topic** 和 **Lambda**。
        * **选项 F:** "Write a condition... when replacement instance is launched"。这在 CFN 里是不存在的。
        * **让我们换个角度：** 这是一个 **Network Appliance** 场景。通常需要在实例 UserData 里写脚本，或者用 Lambda 监听 ASG 事件。
        * 如果没有 Lifecycle Hook 选项，那么可能考的是 **User Data (启动脚本)**？
        * 也没有 User Data 选项。
        * **让我们回到 D, E, F 的组合。**
        * F 肯定是错的。
        * **只有 B, C, D, E 是合理的组件。**
        * 如果必须选 3 个。
        * C (SSM Agent) + D (Alarm -> SNS) + E (Lambda -> Update Route)。
        * 这个逻辑链是：软件发指标 -> 报警 -> 触发 Lambda 更新路由？不对，报警触发的是 ASG 替换。Lambda 应该由 ASG 事件触发。
        * **也许选项 D 的意思是：** 把 ASG 的 Notification 发给 SNS。
        * **假设 D 是配置 ASG 通知。** 那么 E (Lambda 消费 SNS) 是对的。
        * 第三个选什么？
        * 为了让 ASG 知道软件挂了，需要自定义指标（因为 EC2 Status Check 只能看硬件）。
        * 所以 **B (CW Agent)** 或 **C (SSM Agent)** 发送进程指标是必要的。
        * **B vs C:** CW Agent 更常用于发指标。SSM Agent 用于管理。
        * **结论：** **B (发指标) + D (报警触发替换/通知) + E (Lambda 更新路由)**。
        * **注意：** 这里的 D 选项描述 "Create alarm... publish to SNS" 可能包含了两层意思：1. 报警触发 Scaling Policy (替换)。2. ASG 发送通知到 SNS (触发 Lambda)。
        * **更严谨的分析：** 题目说 "Instance is replaced... routes NOT updated"。说明替换已经发生。缺失的是路由更新。
        * 路由更新必须由 **Lambda (E)** 做。
        * Lambda 必须由 **SNS (D)** 触发。
        * 触发源必须是 **ASG 事件**。
        * 还需要 **C (SSM Agent)**？或者 **B**？
        * 题目还说 "Analysis software stops working"。这需要应用层监控。所以 B/C 必选其一。通常 CloudWatch Agent (B) 是发指标的标准。
        * **锁定 B, D, E。**

**3. ✅ 正确选项解析 (选项 B, D, E)**
* **B:** CloudWatch Agent 监控应用进程状态（自定义指标）。
* **D:** 报警触发 ASG 替换，并发送通知（通过 SNS）。
* **E:** Lambda 接收通知，调用 API 更新 VPC 路由表（将流量指向新实例）。

**5. 📚 核心考点:** 网络设备 (Network Appliance) 的高可用与路由自动切换。