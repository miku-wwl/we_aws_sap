#### ğŸ“ [210/529] EC2 SSH å¯†é’¥è½®æ¢ (SSM)

**1. ğŸ•µï¸â€â™‚ï¸ é¢˜çœ¼ä¸çº¦æŸåˆ†æ**
* **éœ€æ±‚ï¼š** è‡ªåŠ¨è½®æ¢ EC2 SSH Key Pairã€‚
* **çº¦æŸï¼š** **< 1 minute downtime** (æçŸ­åœæœºæˆ–ä¸åœæœº)ã€‚
* **å®‰å…¨ï¼š** Keys kept secureã€‚

**2. âš¡ ç§’æ€æ€è·¯**
* **æŠ€æœ¯åŸç†ï¼š**
    * EC2 çš„ SSH å…¬é’¥å­˜å‚¨åœ¨ `~/.ssh/authorized_keys` æ–‡ä»¶ä¸­ã€‚
    * è¦è½®æ¢å¯†é’¥ï¼Œå°±æ˜¯æ›¿æ¢è¿™ä¸ªæ–‡ä»¶é‡Œçš„å…¬é’¥ã€‚
    * è¿™å¯ä»¥é€šè¿‡ **SSM Run Command** åœ¨çº¿æ‰§è¡Œè„šæœ¬å®Œæˆï¼Œ**ä¸éœ€è¦é‡å¯**å®ä¾‹ï¼ˆDowntime = 0ï¼‰ã€‚
* **é€‰é¡¹å¯¹æ¯”ï¼š**
    * é€‰é¡¹ A (Secrets Manager Rotation): Secrets Manager çš„è½®æ¢é€šå¸¸æ˜¯é’ˆå¯¹æ•°æ®åº“å‡­è¯çš„ã€‚è™½ç„¶å¯ä»¥ç”¨è‡ªå®šä¹‰ Lambda è½®æ¢ SSHï¼Œä½†å®ƒæ²¡æœ‰åŸç”Ÿçš„æœºåˆ¶å»"æ¨é€åˆ° EC2"ã€‚
    * é€‰é¡¹ C (KMS): KMS è½®æ¢çš„æ˜¯ KMS å¯†é’¥ï¼ˆç”¨äºåŠ å¯†çš„ï¼‰ï¼Œä¸æ˜¯ SSH å¯†é’¥ã€‚
    * é€‰é¡¹ D (SSM Fleet Manager): è¿™æ˜¯ä¸€ä¸ªé™·é˜±ã€‚Fleet Manager ä¸»è¦æ˜¯ç®¡ç†å·¥å…·ã€‚ä½† **SSM Run Command** æ˜¯æ‰§è¡Œæ“ä½œçš„æ ¸å¿ƒã€‚
    * **é€‰é¡¹ B (SSM Parameter Store + Maintenance Window):**
        * å­˜å‚¨ï¼šç§é’¥å­˜ Parameter Store (SecureString)ã€‚
        * è½®æ¢ï¼šé€šè¿‡ **Maintenance Window** è§¦å‘ Lambdaã€‚
        * åŠ¨ä½œï¼šLambda ç”Ÿæˆæ–°å¯†é’¥ -> æ›´æ–° Parameter Store -> è°ƒç”¨ **SSM Run Command** å°†æ–°å…¬é’¥æ¨é€åˆ° EC2 (`echo "pub_key" > authorized_keys`)ã€‚
        * è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„è‡ªåŠ¨åŒ–è¿ç»´æ¨¡å¼ã€‚
    * **å†çœ‹ A å’Œ B:** å…¶å® A ä¹Ÿå¯ä»¥åšï¼ˆLambda é€»è¾‘ä¸€æ ·ï¼‰ã€‚ä½† B æåˆ°äº† Maintenance Windowï¼Œè¿™æ›´ç¬¦åˆ"è¿ç»´ä»»åŠ¡"çš„è°ƒåº¦ã€‚
    * **å®é™…ä¸Šï¼Œ** æœ€æ–°çš„ AWS å®è·µæ¨èä½¿ç”¨ **EC2 Instance Connect** æ¶ˆé™¤é•¿æœŸ SSH å¯†é’¥ã€‚ä½†å¦‚æœå¿…é¡»è½®æ¢ï¼ŒSSM æ˜¯æ‰§è¡Œé€šé“ã€‚
    * **å¯¹æ¯” A å’Œ B çš„å­˜å‚¨ï¼š** Secrets Manager (A) æ›´é€‚åˆå­˜ç§é’¥ï¼ˆå› ä¸ºæ”¯æŒç»“æ„åŒ–å’Œè‡ªåŠ¨è½®æ¢æ¡†æ¶ï¼‰ã€‚Parameter Store (B) ä¾¿å®œã€‚
    * **ç ´å±€ç‚¹ï¼š** é¢˜ç›®é—® "Which solution..."ã€‚
    * A é€‰é¡¹è¯´ "Secrets Manager rotation schedule invokes Lambda"ã€‚è¿™æ˜¯ Secrets Manager çš„åŸç”ŸåŠŸèƒ½ï¼Œéå¸¸é€‚åˆå‡­è¯è½®æ¢ã€‚
    * B é€‰é¡¹è¯´ "Systems Manager maintenance window invokes Lambda"ã€‚è¿™ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚
    * **å…³é”®åŒºåˆ«ï¼š** **Secrets Manager** ä¸“ä¸º **Secret Rotation** è®¾è®¡ã€‚å®ƒæä¾›äº†ç°æˆçš„æ¡†æ¶ï¼ˆç”Ÿæˆã€è®¾ç½®ã€éªŒè¯ã€å®Œæˆï¼‰ã€‚ç”¨ Secrets Manager æ¥ç®¡ç† SSH å¯†é’¥è½®æ¢æ˜¯æ›´"å®‰å…¨äº§å“åŒ–"çš„æ–¹æ¡ˆã€‚
    * **ä½†æ˜¯ï¼Œ** æ€ä¹ˆæŠŠå…¬é’¥æ¨é€åˆ° EC2ï¼ŸA é€‰é¡¹è¯´ "Replace public key on EC2 instance"ã€‚è¿™é€šå¸¸éœ€è¦ Lambda è°ƒç”¨ SSM Run Commandã€‚
    * **ç»“è®ºï¼š** **A** æ˜¯æ›´ç¬¦åˆ"å¯†é’¥ç®¡ç†"æœ€ä½³å®è·µçš„é€‰é¡¹ï¼ˆé›†ä¸­åœ¨ Secrets Managerï¼‰ã€‚å°½ç®¡ B ä¹Ÿèƒ½è·‘é€šï¼Œä½† Secrets Manager çš„ Rotation Schedule æ˜¯ä¸“é—¨å¹²è¿™ä¸ªçš„ï¼Œæ¯” Maintenance Window æ›´è´´åˆ‡"å‡­è¯è½®æ¢"çš„ä¸»é¢˜ã€‚
    * **ä¿®æ­£ï¼š** æœ‰ä¸€ç§è¯´æ³•æ˜¯ Secrets Manager ä¸»è¦è½®æ¢ DB å¯†ç ã€‚å¯¹äº SSH å¯†é’¥ï¼Œé€šå¸¸ç»“åˆ SSMã€‚ä½†æ˜¯ A é€‰é¡¹æè¿°å¾—éå¸¸å®Œæ•´ï¼ˆç”Ÿæˆã€æ›¿æ¢ã€æ›´æ–°ï¼‰ã€‚Secrets Manager çš„ Lambda Rotator ç¡®å®å¯ä»¥å†™ä»»æ„é€»è¾‘ã€‚
    * **æˆ‘é€‰ Aã€‚** å› ä¸ºå®ƒåˆ©ç”¨äº† Secrets Manager çš„åŸç”Ÿè½®æ¢æ¡†æ¶ã€‚

**3. âœ… æ­£ç¡®é€‰é¡¹è§£æ (é€‰é¡¹ A)**
* **Secrets Manager:** å‡­è¯ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ä¸­å¿ƒã€‚
* **Lambda Rotation:** è‡ªå®šä¹‰é€»è¾‘å®ç° SSH å…¬é’¥æ›¿æ¢ã€‚

**5. ğŸ“š æ ¸å¿ƒè€ƒç‚¹:** è‡ªå®šä¹‰å‡­è¯ï¼ˆé DBï¼‰çš„è‡ªåŠ¨è½®æ¢æ¶æ„ã€‚