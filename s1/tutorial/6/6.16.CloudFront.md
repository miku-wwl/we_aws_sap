# 核心结论先明确：
CloudFront 既能缓存 **静态内容**（默认最优），也能缓存 **满足“可复用性”的动态内容**（需手动配置缓存策略）；**完全实时、不可复用的动态查询（如实时库存、用户实时状态），必须通过后端服务处理**——核心判断标准是“响应是否可复用”，而非“是否动态”。

这是 SAP 认证中“CloudFront 缓存策略”的高频考点（约占 CDN 模块15%分值），重点考察“缓存内容选型+缓存策略配置”，下面结合底层原理、场景案例、SAP 真题深度拆解：


## 一、CloudFront 可缓存的内容（按优先级+场景分类）
CloudFront 缓存的核心逻辑是：**基于“缓存键（Cache Key）”判断请求是否相同，相同请求则返回缓存响应**（默认缓存键=协议+主机头+URL路径+查询参数，可自定义）。可缓存内容需满足“响应可复用”（同一请求多次返回相同结果），具体分为两类：

### （1）默认可缓存：静态内容（无需额外配置，SAP 基础考点）
这是 CloudFront 最核心的使用场景，缓存效率最高、无需复杂配置：
| 内容类型                | 示例                          | 缓存优势                          | SAP 考点场景                          |
|-------------------------|-----------------------------------|-----------------------------------|-----------------------------------|
| 媒体/资源文件           | 图片（.jpg/.png）、视频（.mp4）、音频 | 体积大、访问频繁、修改少，缓存后大幅降低回源带宽 | 电商商品图片、App 静态资源、网站视频 |
| 代码文件               | JS 脚本、CSS 样式表、HTML 静态页面 | 访问频繁、版本化发布（修改后更新文件名即可） | 网站前端代码、静态博客页面          |
| 静态数据文件           | JSON 静态配置（如地区列表、商品分类）、XML 配置 | 不常修改，可复用性高              | 应用配置文件、静态数据字典          |

#### 核心考点：静态内容缓存的默认行为
- 缓存键默认包含 **查询参数**（如 `https://xxx.com/image.jpg?v=1.0`，不同 `v` 值视为不同请求，分别缓存）；
- TTL（缓存过期时间）默认由源站响应头（`Cache-Control`）决定（如源站返回 `Cache-Control: max-age=3600`，则缓存1小时），无响应头时默认缓存24小时；
- 无需手动配置，创建 CloudFront 分配（Distribution）时关联源站（S3/API Gateway/EC2）即可生效。

### （2）需配置可缓存：满足“可复用性”的动态内容（SAP 高频难点）
动态内容（如 API 响应、带查询参数的页面）并非不能缓存，只要“同一请求的响应可复用”，即可通过配置缓存策略实现缓存，核心是“让 CloudFront 识别哪些动态请求是相同的”。

| 动态内容类型                | 示例                          | 缓存策略配置（SAP 考点）                          | 适用场景                          |
|-----------------------------|-----------------------------------|---------------------------------------------------|-----------------------------------|
| 带固定查询参数的 API 响应    | 商品列表查询（`/products?category=electronics`）、天气查询（`/weather?city=shanghai`） | 1. 确保缓存键包含查询参数（默认已包含，无需修改）；<br>2. 设置合理 TTL（如10分钟，对应响应更新频率）；<br>3. 源站响应头添加 `Cache-Control: public`（允许公开缓存） | 响应更新频率低（如10分钟/1小时）、查询参数固定的 API |
| 用户无关的动态页面          | 网站首页（动态渲染但内容1小时更新一次）、活动专题页 | 1. 缓存键排除用户相关 Cookie（避免不同用户视为不同请求）；<br>2. TTL 设为内容更新频率（如1小时） | 内容面向所有用户、更新频率可预测的动态页面 |
| 幂等的 POST 请求响应        | 提交表单后返回的结果（如“订单提交成功”页面，无副作用） | 1. 在 CloudFront 缓存行为中启用“缓存 POST 请求”；<br>2. 确保请求幂等（多次提交结果一致） | 无状态、幂等的 POST 请求（如查询类 POST，非数据提交类） |

#### 关键配置：动态内容缓存的核心步骤（SAP 实操考点）
以“缓存商品列表 API 响应（`/products?category=xxx`）”为例：
1. 进入 CloudFront 分配→缓存行为→编辑：
   - 缓存键设置：保留“查询参数”（默认已勾选，确保不同 `category` 分别缓存）；
   - TTL 设置：最小 TTL=0，最大 TTL=600秒（10分钟），默认 TTL=600秒；
2. 源站（API Gateway/Lambda）配置：
   - 响应头添加 `Cache-Control: public, max-age=600`（明确告知 CloudFront 可缓存10分钟）；
   - 确保响应与用户无关（不包含用户 ID、Session ID 等个性化信息）。

#### SAP 真题示例：
“某电商平台的商品分类列表 API（`/api/categories?type=electronics`），响应10分钟内不变，如何通过 CloudFront 优化访问速度、减少 API Gateway 压力？” → 答案：配置 CloudFront 缓存行为，保留查询参数，设置 TTL=600秒；源站返回 `Cache-Control: public, max-age=600`，实现动态 API 响应缓存。


## 二、CloudFront 不可缓存/不建议缓存的内容（必须走后端服务）
这类内容的核心特征是“响应不可复用”（同一请求不同时间返回不同结果，或不同用户返回不同结果），缓存后会导致数据不一致，必须通过后端服务实时处理：

| 内容类型                | 示例                          | 不可缓存原因                          | SAP 考点判断                          |
|-------------------------|-----------------------------------|-----------------------------------|-----------------------------------|
| 实时数据查询            | 商品实时库存（`/api/stock?productId=123`）、实时交易数据 | 响应每秒变化，缓存后会展示过期数据 | 题干出现“实时”“即时更新”关键词，直接判断不可缓存 |
| 用户个性化内容          | 用户个人中心（`/api/user/profile`）、购物车列表 | 响应与用户身份强相关（需 Cookie/Token 验证），不同用户结果不同 | 题干出现“用户专属”“个性化”关键词，不可缓存 |
| 带状态的 POST 请求      | 提交订单（`/api/orders`）、支付请求（`/api/pay`） | 有副作用（创建订单、扣减库存），多次提交结果不同（非幂等） | 题干出现“提交”“创建”“支付”关键词，不可缓存 |
| 响应头含“禁止缓存”标识  | 源站返回 `Cache-Control: no-cache/no-store` | 源站明确禁止缓存，CloudFront 会忽略缓存策略 | 考点：响应头对缓存的影响，需识别禁止缓存的响应头 |
| 动态生成的一次性内容    | 验证码图片、临时下载链接（有效期1分钟） | 内容仅一次有效，复用会导致功能失效 | 题干出现“一次性”“临时”关键词，不可缓存 |

#### 关键考点：如何让 CloudFront 跳过缓存，直接回源？（SAP 实操）
对不可缓存的内容，需配置 CloudFront 缓存行为“不缓存”，直接转发请求到后端：
1. 缓存行为→编辑：
   - TTL 设置：最小/最大/默认 TTL 均设为0（不缓存）；
   - 缓存键设置：包含所有用户相关标识（如 Cookie、Authorization 头），确保每个请求视为不同请求；
   - 缓存控制：勾选“转发所有缓存控制头”，尊重源站 `no-cache` 指令。


## 三、动态查询的处理逻辑：何时缓存？何时走后端？（SAP 场景题核心）
用流程图快速判断：
```
用户发起动态查询请求 → 步骤1：判断响应是否可复用？
→ 是（相同请求→相同响应，更新频率可预测）→ 配置 CloudFront 缓存策略→ 缓存响应，后续请求直接返回
→ 否（实时数据/用户个性化/有副作用）→ CloudFront 不缓存，直接转发到后端服务（API Gateway→Lambda/EC2）
```

### 典型场景对比（SAP 真题常考）
| 动态查询场景                | 是否可缓存 | 处理方式                          | 缓存策略配置要点                          |
|-----------------------------|------------|-----------------------------------|-----------------------------------|
| 查询商品详情（`/api/product/123`，2小时更新一次） | 是         | CloudFront 缓存                   | TTL=7200秒，缓存键包含商品 ID |
| 查询用户余额（`/api/user/balance`） | 否         | 直接回源到后端                   | TTL=0，转发 Authorization 头 |
| 提交订单（`POST /api/orders`） | 否         | 直接回源到后端                   | 禁止缓存 POST 请求（默认），转发所有请求头 |
| 查询天气（`/api/weather?city=beijing`，10分钟更新一次） | 是         | CloudFront 缓存                   | TTL=600秒，缓存键包含城市参数 |


## 四、SAP 考点总结（必记核心）
1. 缓存内容判断标准：**响应是否可复用**（而非是否动态）；
2. 静态内容：默认缓存，无需额外配置，重点考“源站响应头影响”；
3. 动态内容：可缓存（满足可复用）→ 配置缓存键+TTL+响应头；不可缓存→TTL=0+转发所有标识；
4. 高频误区：
   - 误区1：动态内容不能缓存→ 错！可复用的动态内容（如固定参数 API）可缓存；
   - 误区2：POST 请求不能缓存→ 错！幂等的 POST 请求可通过配置缓存；
   - 误区3：缓存键默认不包含查询参数→ 错！默认包含，动态查询无需额外配置（除非需排除某些参数）；
5. 真题答题技巧：
   - 看到“实时”“个性化”“提交/创建”→ 不可缓存，直接回源；
   - 看到“更新频率×分钟/小时”“固定参数”→ 可缓存，配置对应 TTL 和缓存键。