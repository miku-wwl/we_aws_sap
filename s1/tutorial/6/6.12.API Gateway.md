# API Gateway 终极深度拆解（覆盖所有疑问+SAP考点）
## 一、用户访问后端服务的完整流程（含Route53/CloudFront/ALB等服务排序）
### 1. 核心结论：API Gateway 是「API层入口」，位于CDN（CloudFront）和后端服务（Lambda/EC2）之间，不同场景下流程不同
### 2. 两种典型场景的完整访问链路（从用户到后端）
#### 场景1：公网用户访问无服务器API（最常见，如移动端App调用API）
```
用户 → 1. CloudFront（CDN，加速静态资源+缓存API响应） → 2. Route53（DNS解析，将API域名解析到API Gateway） → 3. API Gateway（统一鉴权、限流、路由） → 4. Lambda/EKS（后端服务）
```
#### 场景2：公网用户访问VPC内后端服务（如EC2部署的微服务）
```
用户 → 1. Route53（解析API域名到API Gateway） → 2. API Gateway（鉴权、限流） → 3. VPC Link（打通API Gateway到VPC的网络） → 4. ALB（负载均衡，分发到EC2实例） → 5. EC2（后端服务）
```
#### 场景3：内部用户访问VPC内API（如员工访问内部系统）
```
用户（EC2/Lambda） → 1. 私有DNS（解析API到Private Endpoint） → 2. Private Endpoint（VPC内访问API Gateway） → 3. API Gateway（鉴权、路由） → 4. VPC内后端服务（如EC2/EKS）
```
### 3. 各服务的核心角色（为什么需要这些“门”？）
| 服务                | 核心角色                          | 是否必须                          |
|---------------------|-----------------------------------|-----------------------------------|
| CloudFront          | CDN加速、缓存、DDoS防护            | 可选（非API核心，优化性能）        |
| Route53             | DNS解析（将域名映射到API Gateway） | 必选（用户通过域名访问，而非IP）    |
| API Gateway         | API统一鉴权、限流、路由、监控      | 必选（企业级API的核心入口）        |
| VPC Link            | 公网API访问VPC内后端的网络通道     | 可选（仅当后端在VPC内时需要）      |
| ALB/NLB             | 后端服务负载均衡（多实例分发流量） | 可选（后端为多实例时推荐）         |

### 关键补充：API Gateway 与 ALB 的区别（SAP常考）
- ALB 是「传输层负载均衡」：负责将流量分发到多台EC2实例，无API层功能（鉴权、限流、路由）；
- API Gateway 是「API层网关」：专注API全生命周期管理（鉴权、限流、文档、监控），可与ALB配合使用（API Gateway→VPC Link→ALB）。


## 二、核心功能深度拆解（按用户疑问逐一详解）
### （1）安检：鉴权（Lambda Authorizer/IAM/Cognito）—— API的“身份验证门”
#### 1. 为什么需要鉴权？
API暴露后，若不验证身份，任何人都能调用（如恶意刷API、窃取数据），鉴权的核心是“只允许合法用户访问”。

#### 2. 三种鉴权方式详解（SAP必考）
##### ① IAM Authorizer（AWS内部用户专用）
- **底层原理**：利用AWS IAM的身份认证机制，验证请求者的IAM角色/用户权限（如EC2的IAM角色、IAM用户的Access Key）。
- **适用场景**：仅AWS内部资源访问API（如Lambda调用另一个Lambda的API、EC2访问API）。
- **鉴权流程**：
  1. 客户端（如EC2）用IAM角色生成临时签名（Signature Version 4），放入请求头；
  2. API Gateway验证签名的有效性和权限（如IAM策略是否允许`execute-api:Invoke`）；
  3. 验证通过则转发请求，失败返回403 Forbidden。
- **优缺点**：
  - 优点：无需额外开发，AWS托管，安全可靠；
  - 缺点：仅适用于AWS内部用户，灵活性低（无法自定义鉴权逻辑）。

##### ② Cognito Authorizer（终端用户认证专用）
- **底层原理**：Amazon Cognito是AWS的用户身份管理服务，支持用户注册、登录、令牌发放（JWT令牌），API Gateway验证Cognito发放的令牌。
- **适用场景**：终端用户访问API（如App登录用户、Web网站用户）。
- **鉴权流程**：
  1. 用户在App/Web登录Cognito，获取JWT令牌（Access Token/ID Token）；
  2. 客户端携带令牌（`Authorization: Bearer {token}`）调用API；
  3. API Gateway验证令牌的签名和有效期（无需调用Cognito服务，本地验证）；
  4. 验证通过则转发请求，失败返回401 Unauthorized。
- **核心优势**：支持OAuth2.0、OpenID Connect，无需开发用户管理系统（注册、登录、密码重置）。

##### ③ Lambda Authorizer（自定义鉴权专用）
- **底层原理**：通过Lambda函数编写自定义鉴权逻辑，验证任何类型的鉴权信息（JWT、API密钥+密码、第三方令牌），返回“允许/拒绝”策略。
- **两种类型（修复后表格）**：

| 类型                | Token-based（令牌型）                | Request-based（请求型）                |
|---------------------|---------------------------------------|---------------------------------------|
| 触发方式            | 客户端在请求头携带令牌（如 `Authorization: Bearer {JWT}`） | 客户端在查询字符串/请求体/头携带鉴权信息（如 `username=xxx&password=xxx`） |
| 适用场景            | JWT验证、第三方OAuth2.0令牌、自定义令牌 | API密钥+密码、签名验证、参数鉴权       |
| 配置关键            | 指定令牌来源（如HTTP头`Authorization`） | 指定请求参数（如查询字符串`username`）  |
| 性能                | 高（支持缓存鉴权结果，默认300秒）     | 中（缓存基于请求参数，命中率较低）     |

- **详细鉴权流程**：
  1. 客户端发送API请求，携带鉴权信息（如JWT令牌、用户名密码）；
  2. API Gateway接收请求，识别到绑定了Lambda Authorizer，触发Lambda函数；
  3. Lambda函数执行自定义逻辑：
     - 若为JWT令牌：解码令牌→验证签名（如用公钥验证）→检查有效期→验证用户权限；
     - 若为用户名密码：查询数据库/Secrets Manager验证正确性；
  4. Lambda返回策略文档（JSON格式）：
     - 允许访问：
       ```json
       {
         "Version": "2012-10-17",
         "Statement": [
           {
             "Effect": "Allow",
             "Action": "execute-api:Invoke",
             "Resource": "arn:aws:execute-api:us-east-1:123456789012:abc123/prod/GET/orders"
           }
         ]
       }
       ```
     - 拒绝访问：
       ```json
       {
         "Version": "2012-10-17",
         "Statement": [{"Effect": "Deny", "Action": "execute-api:Invoke", "Resource": "*"}]
       }
       ```
  5. API Gateway验证策略后，允许/拒绝请求；若允许，缓存鉴权结果（默认300秒），后续相同请求无需再次调用Lambda。

##### ④ 三种鉴权方式对比（修复后表格）
| 鉴权方式          | 适用场景                     | 灵活性       | 配置复杂度 | 典型使用场景                          |
|-------------------|------------------------------|--------------|------------|---------------------------------------|
| IAM Authorizer    | AWS内部用户（EC2、Lambda、IAM用户） | 低（依赖IAM策略） | 低         | 内部服务间API调用（如Lambda调用Lambda） |
| Cognito Authorizer | 终端用户（App、Web登录用户）    | 中（支持OAuth2.0/OpenID Connect） | 中         | 移动端API（如用户查询个人订单）        |
| Lambda Authorizer | 自定义鉴权逻辑（JWT、API密钥+密码、第三方鉴权） | 高（完全自定义代码） | 高         | 合作伙伴API、第三方集成、复杂签名验证  |

### （2）限流：Usage Plans（配额+节流）—— API的“流量控制器”
#### 1. 租户（Tenant）是什么？（用户核心疑问）
- **定义**：租户是指“使用API的独立主体”，可以是合作伙伴、客户、部门、甚至是不同的应用程序；
- **英文名**：Tenant；
- **举例**：某公司将支付API开放给“京东”“淘宝”“拼多多”三个合作伙伴，每个合作伙伴就是一个独立租户。

#### 2. 配额（Quota）vs 节流（Throttle）（核心区别）
| 类型                | 定义                          | 作用                          | 示例配置                          |
|---------------------|-----------------------------------|-----------------------------------|-----------------------------------|
| 配额（Quota）       | 长期调用限制（按天/月/周）        | 限制租户的总调用量，避免资源滥用  | 每天最多1万次，每月最多30万次      |
| 节流（Throttle）    | 瞬时调用限制（按秒/分钟）          | 限制租户的调用频率，避免后端被压垮 | 每秒最多30次，突发流量最多50次（Burst Limit） |

#### 3. 详细配置流程（Step-by-Step+SAP考点）
##### Step 1：创建API并部署到“阶段（Stage）”
- **阶段（Stage）**：API的部署环境（如dev、test、prod），每个阶段可独立配置鉴权、限流、监控；
- **操作**：在API Gateway控制台创建REST API/HTTP API，设计路由（如`/orders` GET/POST），点击“部署”，选择/创建阶段（如prod）。

##### Step 2：创建Usage Plan（使用计划）
- **操作**：
  1. 进入API Gateway→Usage Plans→创建Usage Plan；
  2. 配置基本信息（名称、描述）；
  3. 配置配额：勾选“启用配额”，设置“10000次/天”，“300000次/月”；
  4. 配置节流：勾选“启用节流”，设置“30次/秒”，“突发限制50次”（Burst Limit，允许短时间超阈值）；
  5. 保存Usage Plan。

##### Step 3：绑定API阶段到Usage Plan
- **操作**：
  1. 进入创建好的Usage Plan→关联API→选择要绑定的API和阶段（如prod）；
  2. 点击“添加”，完成绑定（一个Plan可绑定多个API/阶段，如同时绑定支付API和订单API的prod阶段）。

##### Step 4：生成API密钥并关联Usage Plan
- **API密钥**：租户的身份标识，用于API Gateway识别租户（类似“用户名”）；
- **操作**：
  1. 进入Usage Plan→API密钥→创建API密钥（手动输入名称，或自动生成）；
  2. 点击“关联”，将密钥绑定到当前Usage Plan；
  3. 下载/复制密钥（如`abc123xyz`），分发给租户（如合作伙伴）；
  - **考点**：一个密钥仅能关联一个Usage Plan，一个Plan可关联多个密钥（如一个合作伙伴有多个应用，每个应用一个密钥）。

##### Step 5：租户调用API（携带密钥）
- **操作**：租户在HTTP请求头中携带`x-api-key: {密钥}`，示例：
  ```bash
  curl -H "x-api-key: abc123xyz" https://abc123.execute-api.us-east-1.amazonaws.com/prod/orders
  ```
- **API Gateway验证**：
  1. 验证密钥的有效性（是否存在、是否关联Usage Plan）；
  2. 验证配额（是否已达每日上限）；
  3. 验证节流（是否超每秒调用次数）；
  4. 全部通过则转发请求，否则返回错误（429 Too Many Requests）。

#### 4. 关键疑问解答
##### ① API密钥是否需要与KMS结合？SAP会烤吗？
- **答案**：API密钥默认以明文存储在API Gateway，若需加密存储，可集成AWS KMS（将密钥存储在KMS，API Gateway调用KMS解密验证）；
- **SAP考点**：会考察“如何保障API密钥的安全？”→ 答案：使用KMS加密存储API密钥，定期轮换密钥。

##### ② 合作伙伴访问的API是公网还是Private？
- **答案**：通常是公网API（如之前的真题场景），因为合作伙伴的应用不在你的VPC内；
- **若需私有访问**：可让合作伙伴通过VPC对等连接、Transit Gateway接入你的VPC，再通过Private Endpoint访问API（符合合规要求）。

### （3）指路：路由配置—— API的“交通指挥员”
#### 1. 底层原理
API Gateway的路由是“请求路径/方法”与“后端服务”的映射关系，核心是“根据客户端请求的路径和HTTP方法，转发到对应的后端服务”。

#### 2. 详细配置示例（SAP考点）
- **场景**：创建两个路由，分别转发到不同Lambda函数：
  - 路由1：`GET /orders` → 转发到“查询订单”Lambda函数；
  - 路由2：`POST /orders` → 转发到“创建订单”Lambda函数。
- **操作**：
  1. 进入API Gateway→选择API→资源→创建资源（如`orders`）；
  2. 为`/orders`资源创建GET方法：
     - 集成类型选择“Lambda函数”；
     - 选择目标Lambda函数（如`query-orders-function`）；
     - 保存并测试（发送GET请求，API Gateway转发到Lambda，返回订单数据）；
  3. 同理创建POST方法，转发到`create-orders-function`。

#### 3. 解耦的具体体现（用户疑问）
- **后端服务迭代不影响客户端**：若“查询订单”Lambda函数需要迁移到EKS，只需修改路由的集成目标（从Lambda改为EKS的负载均衡地址），客户端无需修改任何配置（仍调用`/orders` GET）；
- **客户端仅需记住一个域名**：所有API（`/orders`、`/payments`、`/users`）都通过同一个API域名暴露（如`https://abc123.execute-api.us-east-1.amazonaws.com/prod`），客户端无需记住多个服务地址。

### （4）内部通道：Private Endpoint—— 内部API的“安全通道”
#### 1. 底层原理（复习+详解）
- **VPC终端节点（VPC Endpoint）**：AWS提供的私有网络通道，允许VPC内的资源（EC2、Lambda、EKS）通过AWS私有网络访问AWS服务（如API Gateway、S3），无需经过公网；
- **API Gateway Private Endpoint**：专门用于API Gateway的VPC Endpoint，将API Gateway“接入”你的VPC，仅允许VPC内资源访问API。

#### 2. 私有DNS名称（复习）
- **定义**：Private Endpoint的默认DNS名称，格式为 `{api-id}.execute-api.{region}.vpce.amazonaws.com`；
- **作用**：VPC内资源通过该DNS名称访问API，请求自动路由到Private Endpoint，走AWS私有网络；
- **示例**：`abc123.execute-api.us-east-1.vpce.amazonaws.com/prod/orders`。

#### 3. 跨VPC访问API的方案（用户核心疑问）
若需跨VPC访问API Gateway（如VPC A的EC2访问VPC B的API Private Endpoint），有两种方案：
##### 方案1：VPC对等连接（VPC Peering）
- **适用场景**：两个VPC在同一区域，网络拓扑简单；
- **原理**：建立两个VPC之间的私有网络连接，VPC A的资源可直接访问VPC B的Private Endpoint。

##### 方案2：AWS Transit Gateway（中转网关）
- **适用场景**：多个VPC（跨区域/同区域），需要统一管理网络连接；
- **原理**：创建Transit Gateway，所有VPC接入中转网关，通过中转网关实现跨VPC通信。

#### 4. Private Endpoint vs VPC Link（修复后表格+详解）
| 概念                | Private Endpoint（私有终端节点）          | VPC Link（VPC链接）                |
|---------------------|-------------------------------------------|-----------------------------------|
| 核心作用            | 让API仅允许VPC内资源访问（限制访问来源）  | 让公网API访问VPC内的后端服务        |
| 访问方向            | VPC内资源 → API Gateway（内部访问API）    | 公网用户 → API Gateway → VPC内后端 |
| 网络传输            | 完全走AWS私有网络，不经过公网            | 公网→API Gateway→私有网络（VPC Link） |
| 适用场景            | 内部系统API（如员工管理系统、后端服务间通信） | 公网API对接VPC内后端（如EC2/EKS部署的微服务） |
| 配置关键            | 关联VPC私有子网、安全组                  | 关联VPC私有子网、安全组            |

### （5）没有API Gateway时，为什么不用ALB替代？（用户疑问）
ALB（应用负载均衡器）虽然能转发HTTP请求，但无法解决API的核心问题，对比如下：
| 问题                | 无API Gateway（仅用ALB）              | 有API Gateway                      |
|---------------------|-----------------------------------|-----------------------------------|
| 鉴权                | 需在每个后端服务中开发鉴权逻辑（重复开发） | 统一鉴权（IAM/Cognito/Lambda Authorizer），无需后端开发 |
| 限流                | 仅支持简单的全局限流（如每秒1000次），无租户级限流 | 支持租户级配额+节流，精细控制资源分配 |
| API管理             | 无API文档、版本控制、监控告警        | 自动生成API文档、支持版本控制、集成CloudWatch监控 |
| 客户端维护          | 客户端需记住多个ALB地址（多个后端服务） | 客户端仅记住一个API域名，路由由API Gateway管理 |
| 无服务器集成        | 无法直接集成Lambda（需额外配置）      | 无缝集成Lambda，构建无服务器API    |

### （6）API Gateway在模块核心目标中的角色（详解）
#### 1. 解耦：隔离客户端和后端服务
- **详解**：客户端仅与API Gateway交互，无需知道后端服务的具体地址、部署方式（Lambda/EC2/EKS）；后端服务可自由迭代（如从Lambda迁移到EKS）、扩容、迁移，只需修改API Gateway的路由配置，客户端无需任何变更。
- **示例**：电商平台的订单API，后端从Lambda迁移到EKS，客户端调用的`/orders`路径不变，仅API Gateway的路由目标从Lambda改为EKS的ALB地址。

#### 2. 高并发：通过节流+配额控制峰值流量
- **详解**：高并发场景（如秒杀），API Gateway可限制每秒调用次数（如1000次），超过阈值的请求返回429错误（客户端可重试），避免后端服务被压垮；同时通过配额限制总调用量，避免单个租户占用所有资源。
- **示例**：秒杀活动中，API Gateway设置节流“1000次/秒”，即使有10万用户同时请求，也仅允许1000次/秒转发到后端，保障后端服务稳定。

#### 3. 安全适配：保护后端服务+优化冷启动体验
- **安全适配**：通过Private Endpoint限制API仅VPC内访问，避免公网暴露；通过鉴权机制拒绝未授权访问，符合合规要求（如金融行业数据不允许公网传输）；
- **冷启动优化**：Lambda冷启动时（首次调用耗时500ms），API Gateway可配置“重试机制”（如重试3次，每次间隔100ms），或启用“响应缓存”（缓存冷启动后的响应），减少用户感知的延迟。


## 三、模块难点总结（详解+SAP避坑）
### 1. 网络配置复杂（Private Endpoint/VPC Link）
- **难点**：容易混淆“访问方向”（VPC内→API vs 公网→API→VPC），不清楚Private Endpoint和VPC Link的适用场景；
- **避坑**：记住“限制访问来源用Private Endpoint，公网API访问VPC后端用VPC Link”，结合跨VPC访问方案（对等连接/Transit Gateway）。

### 2. 鉴权方式选择（场景匹配）
- **难点**：真题中场景复杂，容易选错鉴权方式（如合作伙伴API用了Cognito Authorizer）；
- **避坑**：按“用户类型”快速匹配：AWS内部用户→IAM，终端用户→Cognito，自定义逻辑→Lambda Authorizer。

### 3. 多租户权限隔离（Usage Plans配置）
- **难点**：不清楚API密钥、Usage Plan、阶段的关联关系，配置后限流不生效；
- **避坑**：记住“API密钥→关联Usage Plan→绑定API阶段”的层级关系，限流配置仅对绑定的阶段生效。

### 4. 跨服务依赖（Lambda Authorizer权限配置）
- **难点**：Lambda Authorizer需调用API Gateway，API Gateway需调用Lambda，权限配置错误导致鉴权失败；
- **避坑**：确保：
  1. API Gateway的IAM角色有`lambda:InvokeFunction`权限（调用Lambda Authorizer）；
  2. Lambda Authorizer的IAM角色有`execute-api:Invoke`权限（返回策略给API Gateway）。


## 四、备考总结（必记考点清单+详解）
### 1. Private Endpoint
- **核心考点**：VPC内访问、私有子网+安全组、无公网传输、跨VPC访问方案（对等连接/Transit Gateway）；
- **SAP真题**：“内部API需禁止公网访问，请求不经过互联网，应配置什么？”→ Private Endpoint。

### 2. Usage Plans
- **核心考点**：API密钥+配额+节流、多租户隔离、阶段绑定、KMS加密密钥；
- **SAP真题**：“开放API给多个合作伙伴，需限制每个合作伙伴的调用量和频率，应配置什么？”→ Usage Plans。

### 3. Lambda Authorizer
- **核心考点**：Token-based/Request-based类型、缓存机制、策略文档格式、IAM权限；
- **SAP真题**：“API需验证自研系统颁发的JWT令牌，应选择哪种鉴权方式？”→ Lambda Authorizer（Token-based）。

### 4. 鉴权方式选择
- **核心考点**：按用户类型匹配（AWS内部→IAM，终端用户→Cognito，自定义→Lambda）；
- **SAP真题**：“移动端App用户访问API，需实现注册、登录、令牌验证，应选择哪种鉴权方式？”→ Cognito Authorizer。

### 5. API类型选择
- **核心考点**：高并发低延迟→HTTP API（成本低、性能好），复杂配置（Lambda Authorizer/Usage Plans）→REST API；
- **SAP真题**：“构建高吞吐的API，需支持简单限流和JWT鉴权，应选择哪种API类型？”→ HTTP API。
