# 核心结论：**工程师主导配置，但并非完全“随心所欲”——CF的缓存行为是“工程师主动配置 + 源站响应头约束 + CF默认行为”三者共同决定的**，其中工程师的配置是核心（可覆盖默认行为），但源站响应头会对缓存起到“强制约束”作用（SAP考点重点）。

下面分维度拆解，结合SAP考点讲清“谁决定、怎么决定、约束条件”：

## 一、工程师的主动配置：缓存行为的核心主导（SAP实操考点）
工程师通过CloudFront控制台/API配置的“缓存策略”，是决定“能不能缓存、缓存什么、缓存多久”的核心，几乎所有SAP考题都围绕这部分展开：

### 1. 工程师可直接控制的缓存关键项（必记）
| 配置项                | 作用                          | 示例（SAP真题场景）                          |
|-------------------------|-----------------------------------|-----------------------------------|
| 缓存行为（Cache Behavior）→ TTL设置 | 决定缓存过期时间（0~31536000秒） | 工程师设TTL=600秒（10分钟）→ CF缓存商品API响应10分钟；设TTL=0→不缓存，直接回源 |
| 缓存行为→缓存键（Cache Key） | 决定“哪些请求视为相同请求”（是否缓存） | 工程师选择“包含查询参数”→ `/api/weather?city=sh` 和 `/api/weather?city=bj` 分别缓存；选择“排除Cookie”→ 不同用户的相同请求视为同一请求，共用缓存 |
| 缓存行为→允许缓存的HTTP方法 | 决定是否缓存POST/PUT等非GET请求 | 工程师启用“缓存POST请求”→ 幂等的POST查询请求可缓存；默认仅缓存GET/HEAD→ 不配置则POST请求直接回源 |
| 缓存策略→源站设置 | 决定是否尊重源站响应头 | 工程师选择“遵循源站Cache-Control头”→ 源站禁止缓存时，CF不缓存；选择“覆盖源站头”→ 按工程师配置的TTL缓存（需谨慎，可能导致数据不一致） |

### 2. 工程师的“配置优先级”：可覆盖CF默认行为
CF有自带的“默认缓存行为”（如默认缓存静态内容、默认包含查询参数），但工程师的配置可以直接覆盖这些默认行为：
- 示例1：CF默认缓存`.jpg/.png`等静态文件→ 工程师可在缓存行为中设置“对.jpg文件TTL=0”→ 强制不缓存该类型文件；
- 示例2：CF默认不缓存POST请求→ 工程师启用“缓存POST请求”→ 允许缓存幂等的POST查询响应。

### SAP考点：工程师配置的核心逻辑
真题中常考“工程师应如何配置CF缓存”，核心思路是：
- 想缓存→ 设合理TTL（匹配内容更新频率）+ 配置缓存键（包含必要参数）；
- 不想缓存→ 设TTL=0 + 缓存键包含用户标识（如Cookie/Token）→ 每个请求视为不同，不缓存；
- 条件缓存→ 按请求路径配置不同缓存行为（如`/static/*`设TTL=3600秒，`/api/realtime/*`设TTL=0）。


## 二、源站响应头：缓存的“强制约束”（SAP高频考点）
工程师的配置再详细，也不能违背源站返回的`Cache-Control`等响应头——源站响应头是“缓存规则的底线”，CF会优先遵守：

### 1. 源站响应头对缓存的约束（必记，SAP常考）
| 源站响应头                | 作用（CF的处理逻辑）                          | 工程师配置能否覆盖？                          |
|---------------------------|-----------------------------------------------|-----------------------------------|
| `Cache-Control: no-cache`  | 要求CF每次请求都回源验证，不直接使用缓存       | 不能→ 即使工程师设TTL=3600秒，CF也会回源验证 |
| `Cache-Control: no-store`  | 禁止CF缓存任何响应（包括临时缓存）             | 不能→ 工程师配置无效，CF直接回源，不缓存      |
| `Cache-Control: private`  | 仅允许客户端（如浏览器）缓存，禁止CDN（CF）缓存 | 不能→ CF不会缓存，直接回源                    |
| `Cache-Control: public, max-age=600` | 允许CF缓存600秒                               | 能→ 工程师可设更小TTL（如300秒），但不能设更大（如1200秒，CF最多缓存600秒） |

### 示例（SAP真题场景）：
工程师给某API配置了CF缓存（TTL=3600秒），但源站返回响应头`Cache-Control: no-store`→ 最终CF不会缓存该API响应，每次请求都回源——**源站的“禁止缓存”指令优先级高于工程师配置**。

### SAP考点：响应头与配置的优先级判断
真题常考：“工程师配置CF缓存TTL=600秒，但源站返回`Cache-Control: no-cache`，CF会如何处理？”→ 答案：CF每次回源验证响应有效性，不直接使用缓存（遵循源站响应头）。


## 三、CF的默认行为：缓存的“基础兜底”（SAP基础考点）
如果工程师不做任何自定义配置，CF会按自带的默认规则处理缓存——这是“最小配置成本”的兜底方案，适用于简单场景：

| CF默认行为                | 适用场景                          | 工程师是否可修改？                          |
|---------------------------|-----------------------------------|-----------------------------------|
| 默认可缓存HTTP方法：GET/HEAD | 静态内容、查询类API                | 是→ 可添加POST/PUT等方法（需确保幂等）      |
| 缓存键默认包含：协议+主机头+URL路径+查询参数 | 大多数场景（如不同查询参数的请求分别缓存） | 是→ 可排除查询参数、Cookie、请求头          |
| 默认可缓存内容：所有“无禁止缓存响应头”的内容 | 静态文件（.jpg/.js/.css）、无特殊响应头的动态内容 | 是→ 可通过TTL=0或缓存行为限制特定路径/文件类型 |
| 默认TTL：无源站`Cache-Control`头时，缓存24小时 | 无明确缓存策略的源站                | 是→ 可自定义最小/最大/默认TTL                |

### 示例：
工程师创建CF分配时，仅关联了S3源站（存储静态图片），未做任何缓存配置→ CF默认缓存这些图片24小时，查询参数不同则分别缓存（如`image.jpg?v=1`和`image.jpg?v=2`是两个缓存条目）。


## 四、总结：谁最终决定“能不能缓存”？（SAP备考必记）
| 决策因素                | 作用权重                          | 核心考点                          |
|-------------------------|-----------------------------------|-----------------------------------|
| 工程师的缓存配置（TTL、缓存键、HTTP方法） | 70%（主导）                        | 如何通过配置控制缓存（如缓存动态API、禁止缓存实时数据） |
| 源站响应头（Cache-Control） | 20%（约束）                        | 响应头对缓存的强制影响（如no-store→ 必不缓存） |
| CF默认行为               | 10%（兜底）                        | 默认行为的应用场景（如简单静态内容缓存）      |

### SAP真题答题技巧：
1. 看到“工程师配置CF TTL=xxx”→ 优先考虑配置的影响，但需检查是否有“源站响应头”约束；
2. 看到“源站返回Cache-Control: no-store/no-cache/private”→ 直接判断CF不缓存或回源验证，无论工程师如何配置；
3. 看到“无任何配置”→ 按CF默认行为判断（缓存静态内容、包含查询参数、24小时TTL）。