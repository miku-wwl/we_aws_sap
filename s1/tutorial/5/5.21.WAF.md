# WAF动作类型+Shield Advanced DDoS防御深度拆解（含部署位置答疑）
针对你的三个核心疑问，结合SAP考试考点，从「部署位置逻辑→WAF动作细节→DDoS攻防机制」展开详解，每个部分都补充真题关联点和易混淆点，帮你彻底吃透：


## 一、先答疑：Shield Advanced与WAF的部署位置关系
### 核心结论：**WAF和Shield Advanced都可以部署在CloudFront，且可同时绑定同一目标（如CloudFront、ALB），形成“7层+3-4层”的叠加防护**
两者的部署位置完全兼容，且部署逻辑一致（均为“边缘防护”），具体部署组合如下：

| 防护目标                | WAF是否支持部署                          | Shield Advanced是否支持部署                          | 考试常考组合                          |
|-------------------------|-------------------------------------------|---------------------------------------------------|---------------------------------------|
| CloudFront（CDN）       | ✅ 支持（边缘节点部署）                    | ✅ 支持（边缘节点部署，与CloudFront原生集成）        | 推荐组合：CloudFront + WAF + Shield Advanced（边缘全链路防护） |
| ALB（应用负载均衡）     | ✅ 支持（区域内部署，拦截经过ALB的流量）    | ✅ 支持（区域内部署，防护ALB及后端资源）            | 经典组合：ALB + WAF + Shield Advanced（区域内Web应用防护） |
| Route 53（DNS）         | ❌ 不支持（WAF仅解析HTTP/HTTPS，不解析DNS） | ✅ 支持（防护DNS层面DDoS攻击，如DNS洪水）            | 组合：Route 53 + Shield Advanced + CloudFront（DNS+边缘防护） |
| API Gateway/AppSync     | ✅ 支持（拦截API请求）                      | ❌ 不支持（Shield Advanced仅防护CDN/ALB/Route 53）  | 组合：API Gateway + WAF + Shield Advanced（需通过CloudFront转发） |

### 关键考点（部署位置陷阱）：
1. ❌ 误区：“Shield Advanced部署在CloudFront后，WAF就不能再部署在CloudFront”→ 错！两者可同时绑定CloudFront，流量先经过Shield Advanced（3-4层），再经过WAF（7层），拦截不同层级攻击；
2. ✅ 必记：“CloudFront + WAF + Shield Advanced”是SAP考试中“边缘防护架构”的标准答案（题干出现“Web应用+DDoS防护+低延迟”，优先选此组合）；
3. 部署逻辑类比：CloudFront是“小区大门”，Shield Advanced是“大门的防撞护栏”（拦暴力冲击），WAF是“大门的安检仪”（查危险物品），两者同时工作，互不冲突。


## 二、WAF动作类型详解（4种动作+场景+考试考点）
WAF的动作类型是“规则匹配后的执行逻辑”，SAP考试常考“动作选型题”（如“测试规则是否生效应选哪种动作”），每个动作的细节和考点如下：

### 1. Allow（允许）：放行合规请求
- **核心定义**：请求匹配规则后，直接允许通过，转发到后端目标（如CloudFront、ALB）；
- **使用场景**：白名单规则（如“允许公司办公IP段192.168.0.0/24访问”）；
- **考试考点**：Allow动作的优先级高于其他动作（同一规则组中，先匹配Allow则后续规则不再执行）；
- **易混淆点**：❌ 误区：“Allow动作会记录日志”→ 错！仅允许通过，不记录额外日志（需结合CloudWatch Logs配置日志输出）。

### 2. Block（拦截）：拒绝恶意请求
- **核心定义**：请求匹配规则后，直接拦截，返回**403 Forbidden**响应（可自定义响应页面），不转发到后端；
- **使用场景**：黑名单规则（如“拦截含SQL注入特征的请求”“拦截特定恶意IP”）；
- **考试考点**：
  - 拦截响应码：固定返回403（考试判断题常考“Block动作返回503”→ 错误）；
  - 流量不回源：拦截的请求不会到达后端服务器，不占用资源（核心优势，SAP架构题常考）；
- **真题示例**：
  **题目**：某Web应用需拦截所有含`<script>`标签的请求，应配置WAF的哪种动作？  
  **答案**：Block（匹配XSS规则后直接拦截）。

### 3. Count（计数）：测试/监控规则
- **核心定义**：请求匹配规则后，不拦截、不影响流量，仅在CloudWatch中记录匹配次数（计数+日志）；
- **使用场景**：
  - 新规则测试（如“先计数3天，观察是否有误拦截”）；
  - 攻击监控（如“统计每天SQL注入攻击尝试次数”）；
- **考试高频考点**：
  - ❌ 误区：“Count动作会拦截恶意请求”→ 错！仅记录，不拦截；
  - ✅ 必记：“测试WAF规则有效性的最佳动作是Count”（SAP实操题考点）；
- **真题示例**：
  **题目**：某公司新配置了WAF的速率限制规则，为避免误拦截正常用户，应先选择哪种动作验证规则？  
  **答案**：Count（统计匹配规则的请求，确认无正常用户被误匹配后，再改为Block）。

### 4. Captcha（验证码）：拦截自动化攻击
- **核心定义**：请求匹配规则后，返回验证码页面，用户需手动完成验证（如滑动验证、字符验证），验证通过后才允许访问；
- **使用场景**：拦截爬虫、暴力破解、自动化脚本攻击（如“登录接口每秒请求超过5次，触发验证码”）；
- **考试考点**：
  - 适用场景：仅针对“需要用户交互的Web应用”（如电商前台、登录页），API接口（无用户交互）不适用（考试陷阱）；
  - 与速率限制的区别：速率限制是“直接拦截”，Captcha是“人机验证后放行”，更灵活；
- **易混淆点**：❌ 误区：“Captcha动作适用于API Gateway的接口防护”→ 错！API接口无用户交互，无法完成验证码验证，应选Block或速率限制。

### WAF动作优先级（考试必记）
同一Web ACL中，规则按“优先级从高到低”执行，动作生效逻辑：
1. 先匹配到`Block`/`Captcha`→ 立即执行，后续规则不再处理；
2. 匹配到`Allow`→ 立即放行，后续规则不再处理；
3. 匹配到`Count`→ 记录日志，继续执行下一条规则；
4. 无任何规则匹配→ 默认动作（可配置为Allow或Block，考试常考“默认动作配置”）。

**真题示例（优先级题）**：
**题目**：某WAF Web ACL的规则优先级如下：① 允许IP段192.168.0.0/24（Allow）；② 拦截含SQLi特征的请求（Block）。若来自192.168.0.0/24的请求含SQLi特征，该请求会被如何处理？  
**答案**：允许通过（Allow动作优先级高于Block，先匹配Allow则后续规则不执行）。


## 三、Shield Advanced的DDoS攻防机制（攻击类型+防御手段）
Shield Advanced的核心是“抵御大规模DDoS攻击”，SAP考试常考“攻击类型对应防御手段”，下面从「DDoS攻击分类→SA防御机制→与Basic版差异」展开，结合真题场景：

### 先明确：DDoS攻击的核心目标
通过“海量无效流量”占用目标资源（带宽、连接数、计算资源），导致合法用户无法访问，按OSI层级可分为「网络层DDoS」和「应用层DDoS」。

### （一）常见DDoS攻击类型（SAP考试题干关键词）
| 攻击层级                | 攻击类型                          | 攻击原理（题干常考描述）                          | 典型攻击例子                          |
|-------------------------|-----------------------------------|---------------------------------------------------|---------------------------------------|
| 网络层（3-4层）         | SYN洪水攻击（SYN Flood）           | 伪造大量TCP SYN请求，占用服务器半连接队列（未完成三次握手） | 每秒发送10万+SYN包，导致服务器无法处理合法连接 |
| 网络层（3-4层）         | UDP洪水攻击（UDP Flood）           | 发送大量UDP数据包，占用目标带宽和CPU资源           | 向目标IP的随机端口发送GB级UDP流量       |
| 网络层（3-4层）         | 容量型攻击（Volumetric Attack）    | 超大流量冲击（10Gbps+），耗尽目标带宽             | 100Gbps DDoS流量攻击CloudFront节点     |
| 应用层（7层）           | HTTP洪水攻击（HTTP Flood）         | 伪造大量合法HTTP/HTTPS请求，占用应用服务器资源     | 每秒发送1万+HTTP GET请求，导致Web服务器崩溃 |
| 应用层（7层）           | Slowloris攻击                     | 建立TCP连接后，缓慢发送HTTP请求（如每秒发1个字节），占用连接数 | 维持1万个长连接，耗尽ALB的最大连接数   |
| DNS层（应用层子集）     | DNS洪水攻击（DNS Flood）           | 发送大量DNS查询请求，占用DNS服务器资源             | 向Route 53域名发送每秒5万+查询请求     |

### （二）Shield Advanced的防御机制（对应攻击类型）
Shield Advanced通过“多层防御策略”抵御攻击，核心逻辑是“先识别攻击→再过滤清洗→最后吸收剩余流量”，具体防御手段如下：

#### 1. 攻击识别：流量基线对比+特征库匹配（所有攻击通用）
- **核心逻辑**：SA会先学习正常业务流量的“基线”（如每秒请求数、连接数、流量峰值、协议分布），当实时流量偏离基线（如突然飙升10倍），或匹配到已知攻击特征库（如SYN洪水的数据包特征），则判定为攻击；
- **考试考点**：“Shield Advanced如何识别DDoS攻击？”→ 答案：流量基线对比+攻击特征库匹配；
- **对比Shield Basic**：Basic仅依赖简单特征库，无基线学习能力，无法识别“变异DDoS攻击”（如自定义数据包的SYN洪水）。

#### 2. 网络层DDoS防御（针对SYN/UDP/容量型攻击）
- **手段1：流量清洗（核心防御）**  
  - 原理：SA在边缘节点（CloudFront）或区域网关（ALB前）对流量进行“清洗”，过滤恶意数据包（如伪造IP的SYN包、异常UDP包），仅将合法流量转发到后端；
  - 类比：像“净水器”一样，过滤污水（恶意流量），保留清水（合法流量）；
- **手段2：弹性容量吸收（应对容量型攻击）**  
  - 原理：AWS拥有全球超大带宽资源（Tbps级），SA可调用额外的边缘节点和带宽，吸收100Gbps+的攻击流量，避免目标资源被打垮；
  - 考试考点：“Shield Advanced如何抵御100Gbps容量型DDoS？”→ 答案：弹性容量吸收+流量清洗；
- **手段3：黑洞路由（极端情况）**  
  - 原理：当攻击流量过大（如1Tbps+），SA可将攻击源IP路由到“黑洞”（无响应的网络节点），彻底阻断攻击流量；
  - 注意：仅在万不得已时使用（可能误拦合法IP），需AWS DRT团队协助配置（SA专属权益）。

#### 3. 应用层DDoS防御（针对HTTP洪水/Slowloris）
- **手段1：HTTP请求校验+速率限制**  
  - 原理：SA结合WAF的规则，对HTTP请求进行精细化校验（如检查请求头完整性、是否为自动化脚本发送的请求），并限制单个IP的请求频率（如每秒最多10次）；
  - 依赖关系：SA的应用层防御**必须结合WAF**（SA本身不解析HTTP协议，需WAF提供7层解析能力）；
- **手段2：连接数限制+超时控制**  
  - 原理：限制单个IP的最大并发连接数（如最多100个），并缩短空闲连接超时时间（如10秒），抵御Slowloris攻击（避免长连接占用资源）；
- **考试陷阱**：“Shield Advanced可单独抵御HTTP洪水攻击”→ 错！需结合WAF。

#### 4. DNS层DDoS防御（针对DNS洪水）
- **手段1：DNS请求过滤**  
  - 原理：SA结合Route 53的DNS Firewall，过滤恶意DNS查询（如重复查询、异常来源IP的查询）；
- **手段2：全球Anycast网络疏导**  
  - 原理：Route 53使用全球Anycast网络，将DNS请求分发到最近的边缘节点，避免单个节点被DNS洪水击垮；
- **考试考点**：“防护Route 53的DNS DDoS攻击，应选择哪种服务？”→ 答案：Shield Advanced + Route 53。

#### 5. 专属支持：AWS DRT团队协助（SA核心权益）
- 攻击发生时，24/7专业安全团队（DRT）可：
  - 实时分析攻击源（如识别攻击来自某地区的僵尸网络）；
  - 手动优化防护规则（如临时添加攻击源IP黑名单）；
  - 协调AWS资源（如扩容边缘节点带宽）；
- 考试考点：“Shield Advanced相比Basic，新增的核心权益是什么？”→ 答案：DRT团队支持+扩容费用免除。

### （三）Shield Advanced vs Shield Basic 防御能力对比（SAP必考）
| 攻击类型                | Shield Basic（免费）                          | Shield Advanced（付费）                          | 考试选型关键词                          |
|-------------------------|-----------------------------------------------|---------------------------------------------------|---------------------------------------|
| SYN/UDP洪水（小流量）   | ✅ 支持（基础过滤）                            | ✅ 支持（精准过滤+弹性吸收）                      | 小流量DDoS→Basic；大流量→SA            |
| 容量型攻击（10Gbps+）   | ❌ 不支持（带宽不足）                          | ✅ 支持（Tbps级弹性容量）                          | 题干出现“10Gbps+流量”→ 必选SA          |
| HTTP洪水/Slowloris      | ❌ 不支持（无7层解析能力）                     | ✅ 支持（需结合WAF）                              | 题干出现“Web应用DDoS”→ SA+WAF          |
| DNS洪水攻击             | ❌ 不支持                                      | ✅ 支持（结合Route 53）                            | 题干出现“DNS攻击”→ SA+Route 53         |
| 扩容费用免除            | ❌ 不支持                                      | ✅ 支持（攻击期间弹性扩容费用由AWS承担）            | 题干出现“免除扩容费用”→ 必选SA          |
| DRT团队支持             | ❌ 不支持                                      | ✅ 支持（24/7专业协助）                            | 题干出现“专业安全支持”→ 必选SA          |

### （四）SAP真题示例（DDoS防护选型）
**题目**：某电商平台在双11期间面临以下攻击风险：① 100Gbps容量型DDoS攻击；② HTTP洪水攻击；③ DNS查询洪水攻击；④ 攻击期间需EC2 Auto Scaling扩容，要求免除扩容费用；⑤ 需专业团队实时协助防御。应选择哪些AWS服务组合？  
**答案**：Shield Advanced + WAF + CloudFront + Route 53  
**解析**：
- ① 100Gbps容量型攻击→ SA的弹性容量吸收；
- ② HTTP洪水→ SA+WAF的7层防御；
- ③ DNS洪水→ SA+Route 53；
- ④ 免扩容费→ SA的权益；
- ⑤ 专业支持→ SA的DRT团队。


## 四、核心考点总结（SAP考试必记）
### 1. 部署位置
- WAF和Shield Advanced可同时部署在CloudFront/ALB，形成叠加防护；
- WAF不支持Route 53，Shield Advanced支持Route 53（防护DNS DDoS）。

### 2. WAF动作类型
- Count：测试规则、监控攻击（不拦截）；
- Block：拦截恶意请求（返回403）；
- Allow：放行白名单请求（优先级最高）；
- Captcha：拦截自动化攻击（需用户交互，不适用API）。

### 3. DDoS攻防
- 网络层攻击（SYN/UDP/容量型）→ SA的流量清洗+弹性容量；
- 应用层攻击（HTTP洪水）→ SA+WAF；
- DNS攻击→ SA+Route 53；
- SA的核心优势：抵御大规模攻击、DRT支持、免扩容费。

### 4. 易混淆点
- ❌ WAF的Captcha动作适用于API接口→ 错（无用户交互）；
- ❌ Shield Advanced可单独防护HTTP洪水→ 错（需结合WAF）；
- ❌ Shield Basic支持容量型DDoS→ 错（仅SA支持）；
- ✅ WAF和SA可同时部署在CloudFront→ 正确（推荐组合）。