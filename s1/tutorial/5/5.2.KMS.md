# 零基础拆解KMS核心疑问：CMK/DEK/API/无感加密

## 一、先吃透核心概念：CMK/DEK/明文DEK vs 加密后DEK
### 1. CMK：Customer Master Key（客户主密钥）—— 加密的“根钥匙”
#### （1）全称&定义
CMK是AWS KMS中**最高层级的密钥**，由AWS或用户创建/管理，是整个加密体系的“根”，永远不会离开KMS服务（无论是AWS托管还是用户托管）。

#### （2）核心作用（对应你之前的“银行保险柜钥匙”）
- 不直接加密业务数据（比如视频、文件），只加密“小数据”：比如DEK、密码、令牌（≤4KB）；
- 控制DEK的解密权限（只有拿到CMK，才能解开加密后的DEK）；
- 所有AWS服务的加密（如S3、RDS），本质都是调用CMK完成“信封加密”的核心步骤。

#### （3）通俗例子
CMK就像你家的“房产证”：
- 房产证本身不能直接住房子（对应不加密大文件），但能证明你对房子的所有权；
- 没有房产证，你打不开房子的保险柜（对应解不开DEK），也就拿不到里面的临时钥匙（明文DEK）。

### 2. DEK：Data Encryption Key（数据密钥）—— 加密的“临时密码锁”
#### （1）全称&定义
DEK是专门用来**直接加密业务数据**的对称密钥（默认AES-256），是“一次性/临时性”的密钥（一个DEK通常只加密一份数据）。

#### （2）明文DEK vs 加密后DEK（核心区分，考试必考）
| 类型         | 全称                | 生成方式                | 用途                          | 存储方式                          | 安全性                          |
|--------------|---------------------|-------------------------|-------------------------------|-----------------------------------|---------------------------------|
| 明文DEK      | Plaintext DEK       | KMS的GenerateDataKey API返回 | 直接加密/解密业务数据（比如1GB视频） | 仅存在应用服务器内存中，用完立即销毁 | 极敏感！泄露=数据直接可解密     |
| 加密后的DEK  | Encrypted DEK       | 用CMK加密明文DEK得到    | 随加密数据一起存储/传输        | 和加密后的业务数据一起存在S3/本地 | 安全！无CMK无法解密为明文DEK    |

#### （3）通俗例子（延续快递打包类比）
- 明文DEK：你手里的“临时密码锁”（能直接打开包裹），用完必须销毁，不能存起来；
- 加密后的DEK：用房产证锁起来的“临时密码锁”（装在带锁的信封里），可以放心和包裹一起寄走，别人拿到也打不开。

## 二、KMS常用API：核心+用途+考试考点
KMS的API是SAP考试“实操类考点”的核心，重点记**用途**和**输入/输出**，不用记具体参数，以下是高频API：

### （1）密钥管理类（管理CMK）
| API名称          | 核心用途                                  | 考试考点                          |
|-------------------|-------------------------------------------|-----------------------------------|
| CreateKey         | 创建CMK（用户托管/BYOK类型）              | 创建用户托管CMK的唯一方式         |
| DisableKey        | 禁用CMK（比如员工离职后禁用其创建的CMK）  | 用户托管CMK专属，AWS托管CMK不能用 |
| EnableKey         | 启用被禁用的CMK                           | 同上                              |
| ScheduleKeyDeletion | 计划删除CMK（30天冷却期，可取消）       | 用户托管CMK支持，AWS托管CMK不支持 |
| ListKeys          | 列出账户下所有CMK                         | 排查CMK权限问题时常用            |

### （2）数据加密/解密类（操作小数据）
| API名称          | 核心用途                                  | 输入/输出                          | 考试考点                          |
|-------------------|-------------------------------------------|-----------------------------------|-----------------------------------|
| Encrypt           | 用CMK加密小数据（≤4KB，比如密码）        | 输入：明文数据+CMK ID；输出：加密后数据 | 仅用于小数据，大数据用GenerateDataKey |
| Decrypt           | 用CMK解密Encrypt/GenerateDataKey生成的加密数据 | 输入：加密后数据；输出：明文数据  | 解密加密后的DEK的核心API         |

### （3）DEK生成类（信封加密核心）
#### GenerateDataKey（你重点问的API）
- **核心用途**：生成DEK（明文+加密后），是信封加密的“第一步”；
- **输入参数**：CMK ID（指定用哪把CMK加密DEK）、密钥规格（比如AES_256）；
- **返回两个结果**（考试必考）：
  ① Plaintext（明文DEK）：二进制格式，用于加密业务数据；
  ② CiphertextBlob（加密后的DEK）：用指定CMK加密明文DEK后的结果，可安全存储；
- **关键特性**：KMS只生成，不存储这两个结果，全由用户自己处理。

### （4）其他高频API
| API名称          | 核心用途                                  |
|-------------------|-------------------------------------------|
| GenerateDataKeyWithoutPlaintext | 只生成加密后的DEK（无需明文DEK时用）      |
| ReEncrypt         | 用新CMK重新加密数据（比如密钥轮换后）     |

## 三、解密需要写代码吗？S3能实现“无感加密”吗？
这是最核心的实操疑问，答案分**两种场景**，关键看你用“手动信封加密”还是“AWS服务端自动加密”：

### 场景1：手动信封加密（比如自定义应用加密大文件）→ 必须写代码，无法“无感”
如果是你自己开发应用，加密1GB视频并存在S3，**必须在后端代码中处理解密步骤**，流程如下（简化版Python示例）：
```python
# 1. 从S3下载「加密后的视频 + 加密后的DEK」
s3_client.download_file('my-bucket', 'encrypted_video.mp4', '/local/encrypted_video.mp4')
encrypted_dek = s3_client.get_object('my-bucket', 'encrypted_dek.bin')['Body'].read()

# 2. 调用KMS Decrypt API解密DEK（得到明文DEK）
kms_client = boto3.client('kms')
response = kms_client.decrypt(CiphertextBlob=encrypted_dek)
plaintext_dek = response['Plaintext']  # 明文DEK，仅在内存中

# 3. 用明文DEK解密视频文件（本地/服务器端解密，不上传KMS）
with open('/local/encrypted_video.mp4', 'rb') as f:
    encrypted_data = f.read()
decrypted_video = AES.new(plaintext_dek, AES.MODE_GCM).decrypt(encrypted_data)

# 4. 立即销毁明文DEK（避免泄露）
del plaintext_dek
```
#### 为什么不能“无感”？
因为这是**自定义加密逻辑**，AWS不知道你怎么加密的（比如用了什么加密模式、DEK存在哪），必须由后端代码控制解密流程。

### 场景2：S3服务端加密（SSE-KMS）→ 完全无感，无需写一行加密/解密代码
这是绝大多数企业的选择（也是SAP考试高频考点），AWS会**自动帮你完成信封加密的所有步骤**，后端/用户完全感知不到。

#### （1）SSE-KMS的“无感”逻辑
当你给S3桶启用「SSE-KMS加密」后：
1. 上传文件时：
   - S3自动调用KMS的GenerateDataKey API生成DEK（明文+加密后）；
   - S3用明文DEK加密你的文件，销毁明文DEK；
   - S3把加密后的文件 + 加密后的DEK一起存储（信封加密）；
2. 下载文件时：
   - S3自动调用KMS的Decrypt API解密DEK；
   - S3用明文DEK解密文件，销毁明文DEK；
   - S3把解密后的文件返回给你/后端应用；

#### （2）如何启用SSE-KMS（实操步骤，考试考点）
- 方式1：创建S3桶时，在“加密”选项中选择“Server-side encryption with AWS KMS keys (SSE-KMS)”，指定CMK（AWS托管的aws/s3或用户自定义CMK）；
- 方式2：上传文件时，请求头加`x-amz-server-side-encryption: aws:kms` + `x-amz-server-side-encryption-aws-kms-key-id: CMK的ARN`；

#### （3）后端使用示例（完全无感）
```python
# 上传文件（无需加密代码，S3自动加密）
s3_client.upload_file('local_video.mp4', 'my-bucket', 'video.mp4',
    ExtraArgs={'ServerSideEncryption': 'aws:kms',
               'SSEKMSKeyId': 'arn:aws:kms:us-east-1:123456789012:key/xxx'})

# 下载文件（无需解密代码，S3自动解密）
s3_client.download_file('my-bucket', 'video.mp4', 'local_video_decrypted.mp4')
```
✅ 核心结论：**只要用AWS服务内置的加密（S3 SSE-KMS、RDS存储加密、EBS加密），都是无感的；只有自定义信封加密才需要写代码解密**。

### 补充：S3的3种服务端加密（考试选型考点）
| 加密方式       | 密钥管理                | 无感程度 | 适用场景                          |
|----------------|-------------------------|----------|-----------------------------------|
| SSE-S3         | AWS托管的对称密钥（非KMS） | 完全无感 | 低成本、无需管控密钥              |
| SSE-KMS        | KMS的CMK（AWS托管/用户自定义） | 完全无感 | 需要密钥管控、审计（SAP考试重点） |
| SSE-C          | 用户自己管理的密钥（非KMS） | 需代码   | 合规要求密钥完全脱离AWS管控      |

## 四、总结（SAP考试+实操必记）
1. **CMK/DEK**：CMK是根钥匙（管DEK），DEK是临时锁（加密数据）；明文DEK只在内存，加密后DEK随数据存；
2. **核心API**：GenerateDataKey（生成DEK）、Decrypt（解密DEK）、CreateKey（创建CMK）是考试高频；
3. **无感加密**：优先用S3 SSE-KMS/RDS加密等AWS内置加密，无需代码；自定义加密才需要手动写解密逻辑；
4. **考试陷阱**：题目中说“S3加密无需代码”→ 选SSE-KMS；说“跨区域DR加密无需重加密”→ 选多区域CMK；说“加密大文件”→ 选信封加密（GenerateDataKey）。